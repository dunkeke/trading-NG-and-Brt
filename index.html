<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆçº¦äº¤æ˜“åˆ†æç»ˆç«¯ v7.1 (å¤ç›˜çœ‹æ¿ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0b1220; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #1e3a8a, #14b8a6); border-radius: 999px; }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, #2563eb, #22d3ee); }
        
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 50; }
        .modal-content { background-color: rgba(15, 23, 42, 0.95); color: #e2e8f0; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 18px 45px rgba(2, 6, 23, 0.6); max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; border: 1px solid rgba(148, 163, 184, 0.2); }
        
        .badge { display: inline-block; padding: 0.25em 0.6em; font-size: 0.75em; font-weight: 700; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 0.25rem; }
        .badge-brent { background-color: #dbeafe; color: #1e40af; }
        .badge-hh { background-color: #dcfce7; color: #166534; }
        .badge-jkm { background-color: #ffedd5; color: #9a3412; }
        .badge-ttf { background-color: #f3e8ff; color: #6b21a8; }
        .badge-long { background-color: #ecfdf5; color: #15803d; border: 1px solid #86efac; }
        .badge-short { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fca5a5; }
        
        .table-row-hover:hover { background-color: #f8fafc; }
        .reconcile-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-size: 0.875rem; }
        .subtotal-row { background-color: #f1f5f9; font-weight: 600; color: #475569; }
        
        /* Filter Banner */
        .filter-mode .filter-banner { display: flex; }
        .filter-banner { display: none; }

        /* Dashboard Cards */
        .dash-card { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 0.75rem; padding: 1rem; text-align: center; box-shadow: 0 12px 28px rgba(2, 8, 23, 0.45); }
        .dash-val { font-size: 1.5rem; font-weight: 700; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; margin-top: 0.5rem; }
        .dash-label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.08em; }

        /* Futuristic theme */
        .theme-dark { background: radial-gradient(circle at top, rgba(30, 58, 138, 0.35), rgba(2, 6, 23, 0.95) 55%), linear-gradient(180deg, #0b1120 0%, #020617 100%); }
        .header-glow { position: relative; }
        .header-glow::after { content: ""; position: absolute; inset: -10px 15%; background: radial-gradient(circle, rgba(59, 130, 246, 0.4), transparent 70%); filter: blur(24px); z-index: -1; }
        .panel { background: rgba(15, 23, 42, 0.78); border: 1px solid rgba(148, 163, 184, 0.15); border-radius: 1rem; box-shadow: 0 20px 45px rgba(2, 6, 23, 0.45); backdrop-filter: blur(12px); }
        .panel-title { color: #e2e8f0; letter-spacing: 0.03em; }
        .panel-subtle { background: rgba(30, 41, 59, 0.65); border: 1px solid rgba(59, 130, 246, 0.25); }
        .neon-ring { box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.4), 0 0 18px rgba(37, 99, 235, 0.35); }
        .theme-dark input,
        .theme-dark select,
        .theme-dark textarea { background: rgba(15, 23, 42, 0.8); color: #e2e8f0; border-color: rgba(148, 163, 184, 0.35); }
        .theme-dark input::placeholder { color: #64748b; }
        .theme-dark table thead { background: rgba(30, 41, 59, 0.8); color: #94a3b8; }
        .theme-dark table tbody tr { border-color: rgba(148, 163, 184, 0.12); }
        .theme-dark .table-row-hover:hover { background: rgba(30, 41, 59, 0.6); }
        .theme-dark .subtotal-row { background: rgba(15, 23, 42, 0.95); color: #cbd5f5; }
    </style>
</head>
<body class="theme-dark text-slate-100">
    <!-- Filter Banner -->
    <div id="filter-banner" class="filter-banner fixed top-0 left-0 w-full bg-blue-500 text-white px-4 py-2 justify-between items-center z-50 shadow-md">
        <div class="flex items-center gap-2 font-bold text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" /></svg>
            <span>ğŸ“… ç»Ÿè®¡å‘¨æœŸï¼š<span id="filter-date-display"></span> è‡³ä»Š</span>
        </div>
        <button onclick="clearDateFilter()" class="bg-white text-blue-600 px-3 py-1 rounded text-xs font-bold hover:bg-blue-50 shadow-sm">æ¸…é™¤ç­›é€‰ (æ˜¾ç¤ºå…¨éƒ¨)</button>
    </div>

    <div class="container mx-auto p-4 md:p-6 max-w-7xl mt-8">
        <header class="text-center mb-10 header-glow">
            <p class="text-xs uppercase tracking-[0.35em] text-sky-300 font-semibold mb-3">Aurora Trading Systems</p>
            <h1 class="text-3xl md:text-5xl font-extrabold text-slate-100 tracking-tight">åˆçº¦äº¤æ˜“åˆ†æç»ˆç«¯ v7.1</h1>
            <p class="text-slate-400 mt-3 font-medium">å¤ç›˜çœ‹æ¿ç‰ˆï¼šå½“æ—¥å¹³ä»“ç»Ÿè®¡ | ç»¼åˆä»ªè¡¨ç›˜ | å¯¼å‡ºæŠ¥å‘Š</p>
        </header>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left Column: Controls (4 cols) -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Period Filter Module -->
                <div class="panel panel-subtle p-6">
                    <h2 class="text-lg font-bold mb-2 text-sky-200 flex items-center gap-2 panel-title">
                        ğŸ“… ç»Ÿè®¡å‘¨æœŸç­›é€‰
                    </h2>
                    <p class="text-xs text-slate-300 mb-3">è®¾å®šèµ·å§‹æ—¥æœŸï¼Œä»…ç»Ÿè®¡è¯¥æ—¥æœŸä¹‹åçš„æµæ°´ä¸ç›ˆäºã€‚</p>
                    <div class="flex gap-2">
                        <input type="date" id="filter-date-input" class="flex-grow p-2 border rounded text-sm focus:ring-2 focus:ring-sky-500 neon-ring">
                        <button onclick="applyDateFilter()" class="bg-sky-500 text-slate-900 px-4 py-2 rounded hover:bg-sky-400 text-sm font-semibold shadow-lg shadow-sky-900/40">ç­›é€‰</button>
                    </div>
                </div>

                <!-- Trade Entry Form -->
                <div class="panel p-6">
                    <h2 class="text-lg font-bold mb-4 border-b border-slate-700 pb-3 flex items-center panel-title"><span>ğŸ“ è®°å½•äº¤æ˜“</span></h2>
                    <button onclick="openBatchImportModal()" class="w-full mb-5 bg-gradient-to-r from-indigo-500 to-sky-500 text-white py-2.5 px-4 rounded-lg hover:from-indigo-400 hover:to-sky-400 transition duration-200 flex items-center justify-center gap-2 font-semibold shadow-lg shadow-indigo-900/40 active:transform active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                        æ™ºèƒ½æ–‡æœ¬æ‰¹é‡å¯¼å…¥ (æé€Ÿç‰ˆ)
                    </button>
                    <div class="relative flex py-3 items-center"><div class="flex-grow border-t border-slate-700"></div><span class="flex-shrink-0 mx-4 text-slate-400 text-xs uppercase font-semibold">æ‰‹åŠ¨å½•å…¥</span><div class="flex-grow border-t border-slate-700"></div></div>
                    <form id="trade-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs font-semibold text-slate-400 uppercase mb-1">äº¤æ˜“å‘˜</label><select id="trader" class="block w-full px-3 py-2 border rounded-md text-sm"><option>W</option><option>L</option><option>Z</option><option>D</option></select></div>
                            <div><label class="block text-xs font-semibold text-slate-400 uppercase mb-1">å“ç§</label><select id="product" onchange="updateContractOptions()" class="block w-full px-3 py-2 border rounded-md text-sm"><option value="Brent">Brent</option><option value="Henry Hub">Henry Hub</option><option value="JKM">JKM</option><option value="TTF">TTF</option></select></div>
                        </div>
                        <div><label class="block text-xs font-semibold text-slate-400 uppercase mb-1">åˆçº¦</label><select id="contract" class="block w-full px-3 py-2 border rounded-md text-sm"></select></div>
                        <div><label class="block text-xs font-semibold text-slate-400 uppercase mb-1">äº¤æ˜“ç±»å‹</label><select id="trade-type" class="block w-full px-3 py-2 border rounded-md text-sm"><option value="regular">å¸¸è§„äº¤æ˜“ (è®¡å…¥ç›ˆäº)</option><option value="adjustment">æˆæœ¬è°ƒæ•´ (ä¼˜åŒ–æˆæœ¬)</option></select></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs font-semibold text-slate-400 uppercase mb-1">æ•°é‡ (è´Ÿ=å–)</label><input type="number" id="quantity" step="0.001" placeholder="-10" class="block w-full px-3 py-2 border rounded-md text-sm" required></div>
                            <div><label class="block text-xs font-semibold text-slate-400 uppercase mb-1">ä»·æ ¼</label><input type="number" step="any" id="price" placeholder="60.00" class="block w-full px-3 py-2 border rounded-md text-sm" required></div>
                        </div>
                        <button type="submit" id="submit-btn" class="w-full bg-slate-100 text-slate-900 py-2 px-4 rounded-md hover:bg-white transition duration-200 font-semibold shadow-lg shadow-slate-900/40">æäº¤äº¤æ˜“</button>
                    </form>
                </div>
                
                <!-- Settings -->
                <div class="panel p-6">
                    <h2 class="text-lg font-bold mb-4 border-b border-slate-700 pb-3 panel-title">âš™ï¸ å‚æ•°è®¾ç½®</h2>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-2 items-center"><label class="text-sm text-slate-300">Brent è´¹ç”¨</label><input type="number" step="0.01" id="commission-brent" onchange="updateSettings()" class="text-right w-full px-2 py-1 border rounded text-sm"></div>
                        <div class="grid grid-cols-2 gap-2 items-center"><label class="text-sm text-slate-300">Gas(HH/JKM)</label><input type="number" step="0.0001" id="commission-hh" onchange="updateSettings()" class="text-right w-full px-2 py-1 border rounded text-sm"></div>
                        <div class="grid grid-cols-2 gap-2 items-center"><label class="text-sm text-sky-300 font-medium">TTF æ¢ç®—</label><input type="number" step="0.01" id="ttf-multiplier" onchange="updateSettings()" class="text-right w-full px-2 py-1 border border-sky-400/40 rounded text-sm"></div>
                        <div class="grid grid-cols-2 gap-2 items-center"><label class="text-sm text-slate-300">USD/CNY æ±‡ç‡</label><input type="number" step="0.01" id="exchange-rate-rmb" onchange="updateSettings()" class="text-right w-full px-2 py-1 border rounded text-sm"></div>
                        <div class="grid grid-cols-2 gap-2 items-center"><label class="text-sm text-slate-300">æœŸåˆç›ˆäº</label><input type="number" step="any" id="initial-realized-pl" onchange="updateSettings()" class="text-right w-full px-2 py-1 border rounded text-sm"></div>
                        <div class="border-t pt-2 mt-2"></div>
                        <div class="grid grid-cols-2 gap-2 items-center"><label class="text-sm text-amber-300 font-medium">å¯¹è´¦åŸºå‡†é‡‘</label><input type="number" step="any" id="rec-base-val" onchange="updateSettings()" class="text-right w-full px-2 py-1 border border-amber-300/40 rounded text-sm"></div>
                        <div class="grid grid-cols-2 gap-2 items-center"><label class="text-sm text-amber-300 font-medium">å¯¹è´¦è°ƒèŠ‚é¡¹</label><input type="number" step="any" id="rec-other-val" onchange="updateSettings()" class="text-right w-full px-2 py-1 border border-amber-300/40 rounded text-sm"></div>
                    </div>
                </div>

                <!-- AI Interaction -->
                <div class="panel p-6">
                    <h2 class="text-lg font-bold mb-2 text-sky-200 flex items-center gap-2 panel-title">ğŸ¤– AI åä½œ (NotebookLM)</h2>
                    <button onclick="exportNotebookLMData()" class="w-full bg-slate-900/60 text-sky-200 border border-sky-500/30 py-2 px-4 rounded-md hover:bg-slate-900 transition font-semibold flex items-center justify-center gap-2 text-sm">ç”Ÿæˆè¯­æ–™æ–‡ä»¶ (.txt)</button>
                </div>

                <!-- Data Management -->
                <div class="panel p-6">
                    <h2 class="text-lg font-bold mb-4 border-b border-slate-700 pb-3 panel-title">ğŸ’¾ æ•°æ®ä¸æŠ¥è¡¨</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="exportData()" class="bg-slate-800 text-slate-200 py-2 px-3 rounded hover:bg-slate-700 text-xs">å¤‡ä»½æ•°æ®</button>
                        <label for="import-file" class="cursor-pointer bg-slate-800 text-slate-200 py-2 px-3 rounded hover:bg-slate-700 text-xs text-center block">æ¢å¤æ•°æ®<input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)"></label>
                        <label for="import-mtm-file" class="col-span-2 cursor-pointer bg-emerald-900/40 text-emerald-200 border border-emerald-400/30 py-2 px-3 rounded hover:bg-emerald-900/60 text-xs text-center flex items-center justify-center gap-1">ğŸ“ˆ æ›´æ–°è¡Œæƒ… (JSON)<input type="file" id="import-mtm-file" class="hidden" accept=".json" onchange="importMtmData(event)"></label>
                    </div>
                    <div class="mt-4 space-y-2">
                        <button onclick="exportLedgerCSV()" class="w-full bg-sky-500 text-slate-900 py-2 px-4 rounded hover:bg-sky-400 text-sm font-semibold">å¯¼å‡ºé€æ—¥å°è´¦ (CSV)</button>
                        <button onclick="openReconcileModal()" class="w-full bg-amber-400 text-slate-900 py-2 px-4 rounded hover:bg-amber-300 text-sm font-semibold flex items-center justify-center gap-2">âš–ï¸ èµ„é‡‘å¯¹è´¦åŠ©æ‰‹</button>
                        <button onclick="openDashboardModal()" class="w-full bg-indigo-500 text-white py-2 px-4 rounded hover:bg-indigo-400 text-sm font-semibold shadow-lg shadow-indigo-900/40 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                            ç”Ÿæˆç»¼åˆçœ‹æ¿
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Data (8 cols) -->
            <div class="lg:col-span-8 space-y-6">
                <!-- Stress Test -->
                <div class="panel p-6">
                    <h2 class="text-lg font-bold mb-4 panel-title">âš¡ å‹åŠ›æµ‹è¯•</h2>
                    <div class="flex gap-4 items-end">
                        <div class="flex-1"><label class="block text-xs text-slate-400 mb-1">Brent å˜åŠ¨ ($)</label><input type="number" step="any" id="brent-scenario" placeholder="+5.0" class="w-full p-2 border rounded"></div>
                        <div class="flex-1"><label class="block text-xs text-slate-400 mb-1">Gas å˜åŠ¨ ($)</label><input type="number" step="any" id="hh-scenario" placeholder="-0.5" class="w-full p-2 border rounded"></div>
                        <button onclick="runStressTest()" class="bg-slate-100 text-slate-900 px-6 py-2 rounded hover:bg-white h-10 font-semibold shadow-lg shadow-slate-900/40">è®¡ç®—</button>
                    </div>
                    <div id="stress-test-result" class="mt-4 p-3 bg-slate-900/70 rounded hidden text-center text-sm border border-slate-700">
                        <span class="font-medium">é¢„è®¡ P/L å˜åŠ¨: <span id="pl-change" class="font-bold"></span></span>
                        <span class="mx-4 text-gray-300">|</span>
                        <span class="font-medium">æ–°æµ®åŠ¨ P/L: <span id="new-total-pl" class="font-bold"></span></span>
                    </div>
                </div>

                <!-- Current Positions -->
                <div class="panel p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2 panel-title">
                            ğŸš€ å½“å‰æŒä»“
                            <span class="text-xs font-normal text-slate-300 bg-slate-800 px-2 py-0.5 rounded-full" id="pos-count-badge">0</span>
                        </h2>
                        <div class="flex gap-2">
                            <input type="text" id="search-positions" onkeyup="filterTable('search-positions', 'positions-table')" placeholder="æœç´¢..." class="px-3 py-1 border rounded text-sm w-40">
                            <button onclick="exportPositionsCSV()" class="text-sky-300 hover:bg-slate-800/60 px-3 py-1 rounded text-sm font-medium transition">å¯¼å‡º CSV</button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto rounded-lg border border-slate-700/60">
                        <table class="w-full text-sm text-left text-slate-200">
                            <thead class="text-xs uppercase border-b border-slate-700">
                                <tr>
                                    <th class="px-4 py-3">å“ç§</th><th class="px-4 py-3">åˆçº¦</th><th class="px-4 py-3 text-right">æ•°é‡</th><th class="px-4 py-3 text-center">æ–¹å‘</th><th class="px-4 py-3 text-right">æŒä»“å‡ä»·</th><th class="px-4 py-3 text-right">MTM</th><th class="px-4 py-3 text-right">æµ®åŠ¨ P/L</th><th class="px-4 py-3 text-right">åˆ°å²¸ä»·</th><th class="px-4 py-3 text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="positions-table" class="divide-y divide-gray-100"></tbody>
                            <tfoot class="bg-slate-900/70 font-semibold text-slate-100">
                                <tr><td colspan="6" class="text-right px-4 py-3">æ€»è®¡æµ®åŠ¨ç›ˆäº</td><td id="total-floating-pl" class="px-4 py-3 text-right">0.00</td><td colspan="2"></td></tr>
                                <tr><td colspan="6" class="text-right px-4 py-3">æ€»å‡€æŒä»“é‡</td><td id="total-net-qty" class="px-4 py-3 text-right">0.000</td><td colspan="2"></td></tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <!-- Logs & History -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="panel p-6">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold panel-title">ğŸ“œ äº¤æ˜“æ—¥å¿— (æœ€è¿‘500æ¡)</h3><button onclick="exportLogCSV()" class="text-xs text-sky-300 hover:underline">å¯¼å‡º</button></div>
                        <input type="text" id="search-log" onkeyup="filterTable('search-log', 'log-table')" placeholder="æœç´¢..." class="w-full px-3 py-1 border rounded text-xs mb-2">
                        <div class="overflow-y-auto max-h-64"><table class="w-full text-xs text-left text-slate-300"><thead class="sticky top-0 bg-slate-900/80"><tr><th class="px-2 py-2">æ—¶é—´</th><th>åˆçº¦</th><th>æ•°é‡</th><th>ä»·æ ¼</th><th>æ“ä½œ</th></tr></thead><tbody id="log-table"></tbody></table></div>
                    </div>
                    <div class="panel p-6">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold panel-title">ğŸ å†å²å¹³ä»“ (æœ€è¿‘500æ¡)</h3><button onclick="exportHistoryCSV()" class="text-xs text-sky-300 hover:underline">å¯¼å‡º</button></div>
                        <input type="text" id="search-history" onkeyup="filterTable('search-history', 'history-table')" placeholder="æœç´¢..." class="w-full px-3 py-1 border rounded text-xs mb-2">
                        <div class="overflow-y-auto max-h-64"><table class="w-full text-xs text-left text-slate-300"><thead class="sticky top-0 bg-slate-900/80"><tr><th class="px-2 py-2">æ—¥æœŸ</th><th>åˆçº¦</th><th>å¹³ä»“é‡</th><th>ç›ˆäº</th></tr></thead><tbody id="history-table"></tbody><tfoot class="sticky bottom-0 bg-slate-900/80 font-bold"><tr><td colspan="3" class="text-right px-2">ç´¯è®¡</td><td id="total-realized-pl">0.00</td></tr></tfoot></table></div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="panel p-6">
                    <h2 class="text-lg font-bold mb-4 border-b border-slate-700 pb-2 panel-title">ğŸ“Š æ•°æ®å¯è§†åŒ–</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><h3 class="text-sm font-medium text-center mb-2 text-slate-300">æŒä»“å¸‚å€¼ç»“æ„</h3><div class="chart-container"><canvas id="position-structure-chart"></canvas></div></div>
                        <div><h3 class="text-sm font-medium text-center mb-2 text-slate-300">ç´¯è®¡ç›ˆäºæ›²çº¿</h3><div class="chart-container"><canvas id="realized-pl-chart"></canvas></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="edit-modal" class="modal-backdrop hidden"><div class="modal-content"><h2 class="text-xl font-bold mb-4">ç¼–è¾‘æŒä»“</h2><form id="edit-form" class="space-y-4"><input type="hidden" id="edit-index"><label class="block text-sm">æ•°é‡<input type="number" id="edit-quantity" class="w-full border p-2 rounded" required></label><label class="block text-sm">å‡ä»·<input type="number" step="any" id="edit-price" class="w-full border p-2 rounded" required></label><div class="flex justify-end gap-2"><button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-slate-700 text-slate-100 rounded hover:bg-slate-600">å–æ¶ˆ</button><button type="submit" class="px-4 py-2 bg-sky-500 text-slate-900 rounded hover:bg-sky-400 font-semibold">ä¿å­˜</button></div></form></div></div>
    <div id="action-confirm-modal" class="modal-backdrop hidden"><div class="modal-content text-center"><h2 id="confirm-title" class="text-xl font-bold mb-4"></h2><p id="confirm-body" class="mb-6 text-slate-300"></p><div class="flex justify-center gap-4"><button id="confirm-cancel-btn" type="button" onclick="closeActionConfirmModal()" class="bg-slate-700 text-slate-100 py-2 px-6 rounded-md hover:bg-slate-600">å–æ¶ˆ</button><button id="confirm-action-btn" type="button" class="bg-red-600 text-white py-2 px-6 rounded-md hover:bg-red-500">ç¡®è®¤</button></div></div></div>
    
    <div id="reconcile-modal" class="modal-backdrop hidden">
        <div class="modal-content max-w-2xl w-full">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><span class="text-amber-300">âš–ï¸</span> èµ„é‡‘å¯¹è´¦åŠ©æ‰‹</h2>
            <p class="text-sm text-slate-300 mb-6 bg-amber-900/30 p-3 rounded border border-amber-400/40">æ ¸å¯¹å…¬å¼ï¼š<b>æ°´å•æ€»ç›ˆäº</b> â‰ˆ <b>(Appç´¯è®¡å®ç°P/L + Appæµ®åŠ¨å‡€P/L)</b> - <b>è°ƒèŠ‚é¡¹</b></p>
            <div class="space-y-4">
                <div class="reconcile-row"><label class="font-medium w-1/3">App ç´¯è®¡å®ç°ç›ˆäº:</label><span id="rec-app-realized" class="font-mono text-slate-100"></span></div>
                <div class="reconcile-row"><label class="font-medium w-1/3">App æµ®åŠ¨å‡€ç›ˆäº:</label><span id="rec-app-floating" class="font-mono text-slate-100"></span></div>
                <hr class="border-slate-700">
                <div class="reconcile-row"><label class="font-medium w-1/3">â– å¯¹è´¦åŸºå‡†é‡‘:</label><input type="number" id="modal-rec-base" class="reconcile-input bg-slate-800/70 cursor-not-allowed" readonly></div>
                <div class="reconcile-row"><label class="font-medium w-1/3">â– å¯¹è´¦è°ƒèŠ‚é¡¹:</label><input type="number" id="modal-rec-other" class="reconcile-input bg-slate-800/70 cursor-not-allowed" readonly></div>
                
                <div class="mt-4"><button type="button" onclick="toggleRecDetails()" class="text-xs text-sky-300 hover:underline flex items-center gap-1"><span id="rec-detail-icon">â–¶</span> æŸ¥çœ‹æŒä»“æ˜ç»† (ç”¨äºæ’æŸ¥)</button><div id="rec-detail-table" class="hidden mt-2 border border-slate-700 rounded overflow-hidden"><table class="w-full text-xs text-left bg-slate-900/70"><thead class="bg-slate-800/70"><tr><th class="p-2">åˆçº¦</th><th class="p-2 text-right">æ•°é‡</th><th class="p-2 text-right">MTM</th><th class="p-2 text-right">æµ®åŠ¨P/L</th></tr></thead><tbody id="rec-detail-body"></tbody></table></div></div>

                <div class="reconcile-row bg-slate-800/70 p-2 rounded mt-4"><label class="font-bold w-1/3 text-slate-200">App è®¡ç®—å‡€å€¼:</label><span id="rec-app-net" class="font-bold font-mono text-lg"></span></div>
                <hr class="border-slate-700 border-dashed my-4">
                <div class="reconcile-row"><label class="font-bold w-1/3 text-sky-300">ğŸ“ æ°´å• Total P/L (è¾“å…¥):</label><input type="number" id="rec-statement-val" class="reconcile-input border-sky-400/50 focus:ring-sky-500" placeholder="è¾“å…¥æ°´å•Xåˆ—æ€»å’Œ" onkeyup="calcReconcile()"></div>
                <div class="mt-6 p-4 rounded-lg text-center bg-slate-900/70 border border-slate-700" id="rec-result-box"><div class="text-sm text-slate-400 mb-1">å·®å¼‚é‡‘é¢ (æ°´å• - App)</div><div id="rec-diff-val" class="text-3xl font-bold font-mono">0.00</div><div id="rec-status-text" class="text-sm font-semibold mt-2"></div></div>
            </div>
            <div class="flex justify-end space-x-3 mt-6"><button onclick="closeReconcileModal()" class="bg-slate-700 text-slate-100 py-2 px-6 rounded-md hover:bg-slate-600">å…³é—­</button></div>
        </div>
    </div>
    
    <!-- NEW v7.1: Dashboard Modal -->
    <div id="dashboard-modal" class="modal-backdrop hidden">
        <div class="modal-content w-full max-w-4xl">
            <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-100 flex items-center gap-2">ğŸ“Š ç»¼åˆå¤ç›˜çœ‹æ¿</h2>
                    <p class="text-sm text-slate-400 mt-1" id="dash-date-display"></p>
                </div>
                <button onclick="closeDashboardModal()" class="text-slate-400 hover:text-slate-200"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="dash-card border-l-4 border-emerald-400/70">
                    <div class="dash-label">å½“æ—¥å®ç°ç›ˆäº (Realized)</div>
                    <div class="dash-val text-green-600" id="dash-realized"></div>
                </div>
                <div class="dash-card border-l-4 border-sky-400/70">
                    <div class="dash-label">å½“å‰æ€»æµ®åŠ¨ç›ˆäº (Floating)</div>
                    <div class="dash-val text-blue-600" id="dash-floating"></div>
                </div>
                <div class="dash-card border-l-4 border-purple-400/70">
                    <div class="dash-label">å½“æ—¥äº¤æ˜“ç¬”æ•°</div>
                    <div class="dash-val text-purple-600" id="dash-tx-count"></div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Today's Closed Trades -->
                <div class="bg-slate-900/70 p-4 rounded-lg shadow-sm border border-slate-700">
                    <h3 class="text-sm font-bold text-slate-200 mb-3 border-b border-slate-700 pb-2">ğŸ“‰ å½“æ—¥å¹³ä»“æ˜ç»†</h3>
                    <div class="overflow-y-auto max-h-60">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-slate-800/80 sticky top-0 text-slate-400"><tr><th class="p-2">åˆçº¦</th><th class="p-2">æ–¹å‘</th><th class="p-2 text-right">å¹³ä»“é‡</th><th class="p-2 text-right">P/L</th></tr></thead>
                            <tbody id="dash-closed-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Current Positions Summary -->
                <div class="bg-slate-900/70 p-4 rounded-lg shadow-sm border border-slate-700">
                    <h3 class="text-sm font-bold text-slate-200 mb-3 border-b border-slate-700 pb-2">ğŸ“¦ å½“å‰æŒä»“æ±‡æ€»</h3>
                    <div class="overflow-y-auto max-h-60">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-slate-800/80 sticky top-0 text-slate-400"><tr><th class="p-2">å“ç§</th><th class="p-2 text-right">å‡€æŒä»“</th><th class="p-2 text-right">åŠ æƒå‡ä»·</th><th class="p-2 text-right">æµ®åŠ¨P/L</th></tr></thead>
                            <tbody id="dash-pos-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-slate-700">
                <button onclick="exportDashboardReport()" class="bg-indigo-500 text-white py-2 px-6 rounded-md hover:bg-indigo-400 flex items-center gap-2 text-sm font-bold shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    å¯¼å‡ºçœ‹æ¿æŠ¥å‘Š (.txt)
                </button>
            </div>
        </div>
    </div>

    <div id="batch-import-modal" class="modal-backdrop hidden">
        <div class="modal-content max-w-4xl w-full">
            <h2 class="text-xl font-bold mb-2">æ™ºèƒ½æ–‡æœ¬æ‰¹é‡å¯¼å…¥ (æé€Ÿç‰ˆ)</h2>
            <p class="text-xs text-slate-400 mb-4">æ”¯æŒ: 1) Sold 200x Brent May26 | 50x pm Jul26-Dec26 | Bought TTF 26Q4 | D sold ...</p>
            <textarea id="batch-input" rows="12" class="w-full p-3 border border-slate-600 rounded-md font-mono text-sm focus:ring-2 focus:ring-indigo-500" placeholder="åœ¨æ­¤ç²˜è´´äº¤æ˜“æ–‡æœ¬..."></textarea>
            <div class="flex justify-end space-x-3 my-4"><button onclick="parseImportText()" class="bg-indigo-500 text-white py-2 px-6 rounded hover:bg-indigo-400">è§£æé¢„è§ˆ</button></div>
            <div id="import-preview-container" class="hidden">
                <div class="overflow-x-auto border border-slate-700 rounded-md max-h-64"><table class="w-full text-xs text-left"><thead class="bg-slate-800/80 sticky top-0"><tr><th class="px-4 py-2">çŠ¶æ€</th><th>äº¤æ˜“å‘˜</th><th>å“ç§</th><th>åˆçº¦</th><th>æ–¹å‘</th><th>æ•°é‡</th><th>ä»·æ ¼</th></tr></thead><tbody id="import-preview-body"></tbody></table></div>
                <div class="mt-4 flex justify-between items-center"><span id="import-summary" class="text-sm font-bold text-slate-200"></span><div class="space-x-3"><button onclick="closeBatchImportModal()" class="bg-slate-700 px-4 py-2 rounded text-slate-100 hover:bg-slate-600">å–æ¶ˆ</button><button onclick="batchSubmitTrades()" id="btn-batch-submit" class="bg-emerald-500 text-slate-900 px-4 py-2 rounded hover:bg-emerald-400 font-semibold">ç¡®è®¤æäº¤</button></div></div>
            </div>
        </div>
    </div>

<script>
// ==================== 1. CONFIGURATION ====================
function generateContracts(start, end) {
    return ['2602','2603','2604','2605','2606','2607','2608','2609','2610','2611','2612','2701','2702','2703','26Q4','27Q1'];
}
const config = {
    traders: ['W', 'L', 'Z', 'D'], 
    contracts: {
        'Brent': generateContracts(),
        'Henry Hub': ['HH2511','HH2512','HH2601','HH2607'],
        'JKM': generateContracts(),
        'TTF': generateContracts()
    },
    contractMultipliers: { 'Brent': 1000, 'Henry Hub': 10000, 'JKM': 10000, 'TTF': 10000 },
    colors: { 'Brent': 'badge-brent', 'Henry Hub': 'badge-hh', 'JKM': 'badge-jkm', 'TTF': 'badge-ttf' }
};

// ==================== 2. GLOBAL STATE ====================
let state = {
    positions: [], history: [], transactionLog: [], marketPrices: {},
    settings: { 
        fees: { brentPerBbl: 0, hhPerMMBtu: 0 }, 
        exchangeRateRMB: 7.13, 
        initialRealizedPL: 0,
        reconciliation: { base: 156170, other: 45800 },
        ttfMultiplier: 3412
    },
    filterDate: null
};
let positionChart = null, plChart = null, parsedTradesBuffer = [];

// ==================== 3. INITIALIZATION & UTILS ====================
function hydrateState() {
    if(!state.positions) state.positions=[]; if(!state.history) state.history=[]; 
    if(!state.transactionLog) state.transactionLog=[]; if(!state.marketPrices) state.marketPrices={};
    if(!state.settings) state.settings={ fees:{brentPerBbl:0, hhPerMMBtu:0}, exchangeRateRMB:7.13, initialRealizedPL:0, reconciliation: { base: 156170, other: 45800 }, ttfMultiplier: 3412 };
    if(!state.settings.reconciliation) state.settings.reconciliation = { base: 156170, other: 45800 }; 
    if(!state.settings.ttfMultiplier) state.settings.ttfMultiplier = 3412;
    state.transactionLog.forEach(l => { if(!l.id) l.id=Date.now()+Math.random(); if(!l.status) l.status='active'; if(!l.type) l.type = 'regular'; });
    state.filterDate = null; 
}

function initializeUI() {
    updateContractOptions();
    document.getElementById('commission-brent').value = state.settings.fees.brentPerBbl;
    document.getElementById('commission-hh').value = state.settings.fees.hhPerMMBtu;
    document.getElementById('exchange-rate-rmb').value = state.settings.exchangeRateRMB;
    document.getElementById('initial-realized-pl').value = state.settings.initialRealizedPL;
    document.getElementById('rec-base-val').value = state.settings.reconciliation.base;
    document.getElementById('rec-other-val').value = state.settings.reconciliation.other;
    document.getElementById('ttf-multiplier').value = state.settings.ttfMultiplier;
}

function getPricePrecision(product) { return product === 'Henry Hub' ? 4 : 2; }
function formatPrice(price, product) { if (typeof price !== 'number') return 'N/A'; return price.toFixed(getPricePrecision(product)); }
function saveState() { localStorage.setItem('tradeAppState', JSON.stringify(state)); }
function loadState() { const s = localStorage.getItem('tradeAppState'); if (s) state = JSON.parse(s); }
function formatDateForExport(isoString, includeTime = true) { 
    try { const date = new Date(isoString); const YYYY = date.getFullYear(); const MM = String(date.getMonth() + 1).padStart(2, '0'); const DD = String(date.getDate()).padStart(2, '0'); if (!includeTime) return `${YYYY}-${MM}-${DD}`; const hh = String(date.getHours()).padStart(2, '0'); const mm = String(date.getMinutes()).padStart(2, '0'); const ss = String(date.getSeconds()).padStart(2, '0'); return `${YYYY}-${MM}-${DD} ${hh}:${mm}:${ss}`; } catch(e) { return isoString; }
}

// ==================== 4. MODALS ====================
function openInfoModal(t, b) { document.getElementById('confirm-title').textContent = t; document.getElementById('confirm-body').textContent = b; document.getElementById('confirm-action-btn').onclick = closeActionConfirmModal; document.getElementById('confirm-action-btn').textContent = 'å¥½çš„'; document.getElementById('confirm-cancel-btn').classList.add('hidden'); document.getElementById('action-confirm-modal').classList.remove('hidden'); }
function openConfirmModal(t, b, fn) { document.getElementById('confirm-title').textContent = t; document.getElementById('confirm-body').textContent = b; document.getElementById('confirm-action-btn').onclick = fn; document.getElementById('confirm-action-btn').textContent = 'ç¡®è®¤'; document.getElementById('confirm-cancel-btn').classList.remove('hidden'); document.getElementById('action-confirm-modal').classList.remove('hidden'); }
function closeActionConfirmModal() { document.getElementById('action-confirm-modal').classList.add('hidden'); }
function openEditModal(i) { document.getElementById('edit-index').value = i; document.getElementById('edit-modal').classList.remove('hidden'); }
function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }
function handleEditSubmit(e) { e.preventDefault(); openInfoModal('æç¤º', 'ä¸ºä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œè¯·é€šè¿‡æ’¤é”€åŠŸèƒ½ä¿®æ”¹äº¤æ˜“ã€‚'); closeEditModal(); }
function openBatchImportModal() { document.getElementById('batch-input').value = ''; document.getElementById('import-preview-container').classList.add('hidden'); document.getElementById('batch-import-modal').classList.remove('hidden'); }
function closeBatchImportModal() { document.getElementById('batch-import-modal').classList.add('hidden'); parsedTradesBuffer = []; }

// v6.9 Reconciliation with Details
function openReconcileModal() {
    let historyPL = 0;
    const relevantHistory = state.filterDate 
        ? state.history.filter(h => h.date >= state.filterDate) 
        : state.history;
    historyPL = relevantHistory.reduce((a,b)=>a+b.realizedPL,0);
    const totalR = (state.filterDate ? 0 : (state.settings.initialRealizedPL||0)) + historyPL;
    
    let totalF = 0; 
    let detailHtml = '';
    state.positions.forEach(p=>{ 
        const c=state.marketPrices[p.contract]||(p.totalValue/p.quantity); 
        const mult = p.product === 'TTF' ? state.settings.ttfMultiplier : config.contractMultipliers[p.product];
        const g=(c*p.quantity*mult)-(p.totalValue*mult); 
        const f=p.product==='Brent'?state.settings.fees.brentPerBbl:state.settings.fees.hhPerMMBtu; 
        const net = g-(Math.abs(p.quantity)*mult*f);
        totalF+=net; 
        detailHtml += `<tr class="border-b"><td class="p-2">${p.contract}</td><td class="p-2 text-right">${p.quantity.toFixed(3)}</td><td class="p-2 text-right">${c.toFixed(2)}</td><td class="p-2 text-right ${net>=0?'text-green-600':'text-red-600'}">${net.toFixed(0)}</td></tr>`;
    });
    
    const recSettings = state.settings.reconciliation || { base: 156170, other: 45800 };
    document.getElementById('modal-rec-base').value = recSettings.base;
    document.getElementById('modal-rec-other').value = recSettings.other;
    document.getElementById('rec-app-realized').textContent = `$${totalR.toFixed(2)}`; 
    document.getElementById('rec-app-floating').textContent = `$${totalF.toFixed(2)}`;
    document.getElementById('rec-detail-body').innerHTML = detailHtml;
    
    calcReconcile(); document.getElementById('reconcile-modal').classList.remove('hidden');
}

function toggleRecDetails() {
    const el = document.getElementById('rec-detail-table');
    const icon = document.getElementById('rec-detail-icon');
    if (el.classList.contains('hidden')) { el.classList.remove('hidden'); icon.textContent = 'â–¼'; } else { el.classList.add('hidden'); icon.textContent = 'â–¶'; }
}
function closeReconcileModal() { document.getElementById('reconcile-modal').classList.add('hidden'); }
function closeReportModal() { document.getElementById('report-modal').classList.add('hidden'); }
function closeDashboardModal() { document.getElementById('dashboard-modal').classList.add('hidden'); }
function copyReportToClipboard() { navigator.clipboard.writeText(document.getElementById('daily-report-content').textContent); alert('å·²å¤åˆ¶'); }

// ==================== 5. ACTIONS & LOGIC ====================
function handleTradeSubmit(e) {
    e.preventDefault();
    if(state.filterDate) return alert("è¯·å…ˆæ¸…é™¤ç­›é€‰");
    const t = document.getElementById('trader').value;
    const p = document.getElementById('product').value;
    const c = document.getElementById('contract').value;
    const q = parseFloat(document.getElementById('quantity').value);
    const pr = parseFloat(document.getElementById('price').value);
    const ty = document.getElementById('trade-type').value;
    if(isNaN(q) || isNaN(pr)) return openInfoModal("é”™è¯¯", "è¯·è¾“å…¥æœ‰æ•ˆæ•°å€¼");
    addTransaction(t, p, c, q, pr, ty);
    document.getElementById('trade-form').reset();
}

function addTransaction(trader, product, contract, qty, price, type) {
    state.transactionLog.push({ id: Date.now()+Math.random(), date: new Date().toISOString(), trader, product, contract, quantity: qty, price, status:'active', type });
    updateUI();
}

function updateUI() { rebuildStateFromLogs(); saveState(); renderAll(); }

function reverseTrade(id) {
    if(state.filterDate) return alert("ç­›é€‰æ¨¡å¼ä¸‹ä¸å¯ä¿®æ”¹");
    const log = state.transactionLog.find(l => l.id === id);
    if(log && confirm(`ç¡®è®¤æ’¤é”€ ${log.contract} ${log.quantity} @ ${log.price}?`)) {
        log.status = 'reversed'; updateUI();
    }
}
function reverseTradeByPos(key) {
    if(state.filterDate) return alert("ç­›é€‰æ¨¡å¼ä¸‹ä¸å¯ä¿®æ”¹");
    const log = state.transactionLog.slice().reverse().find(l => `${l.trader}-${l.product}-${l.contract}` === key && l.status === 'active');
    if(log) reverseTrade(log.id); else alert("æœªæ‰¾åˆ°å¯æ’¤é”€çš„äº¤æ˜“è®°å½•");
}

function updateSettings() {
    state.settings.fees.brentPerBbl = parseFloat(document.getElementById('commission-brent').value)||0;
    state.settings.fees.hhPerMMBtu = parseFloat(document.getElementById('commission-hh').value)||0;
    state.settings.exchangeRateRMB = parseFloat(document.getElementById('exchange-rate-rmb').value)||7.13;
    state.settings.initialRealizedPL = parseFloat(document.getElementById('initial-realized-pl').value)||0;
    state.settings.reconciliation = {
        base: parseFloat(document.getElementById('rec-base-val').value)||0,
        other: parseFloat(document.getElementById('rec-other-val').value)||0
    };
    state.settings.ttfMultiplier = parseFloat(document.getElementById('ttf-multiplier').value)||3412;
    updateUI();
}

function updateMtmPrice(key, val) {
    const pos = state.positions.find(p => p.key === key);
    if(pos) { state.marketPrices[pos.contract] = parseFloat(val); updateUI(); }
}

function updateContractOptions() {
    const p = document.getElementById('product').value;
    document.getElementById('contract').innerHTML = (config.contracts[p] || []).map(c => `<option value="${c}">${c}</option>`).join('');
    document.getElementById('price').placeholder = (p === 'Henry Hub' || p === 'TTF') ? '2.8500' : '85.500';
}

function filterTable(inputId, tableId) { 
    const term = document.getElementById(inputId).value.toLowerCase(); 
    const rows = document.getElementById(tableId).getElementsByTagName('tr'); 
    for(let r of rows) { 
        if(r.classList.contains('subtotal-row') || r.innerText.includes('æ€»è®¡')) continue; 
        r.style.display = r.textContent.toLowerCase().includes(term) ? '' : 'none'; 
    } 
}

function calcReconcile() {
    const r=parseFloat(document.getElementById('rec-app-realized').textContent.replace('$',''))||0; 
    const f=parseFloat(document.getElementById('rec-app-floating').textContent.replace('$',''))||0;
    const a1=parseFloat(document.getElementById('modal-rec-base').value)||0; 
    const a2=parseFloat(document.getElementById('modal-rec-other').value)||0; 
    const s=parseFloat(document.getElementById('rec-statement-val').value)||0;
    const net=r+f-a1-a2; 
    document.getElementById('rec-app-net').textContent=`$${net.toFixed(2)}`;
    const diff=s-net; 
    document.getElementById('rec-diff-val').textContent=(diff>0?'+':'')+diff.toFixed(2);
    const bEl=document.getElementById('rec-result-box'); const tEl=document.getElementById('rec-status-text');
    if(Math.abs(diff)<1) { bEl.className='mt-6 p-4 rounded-lg text-center bg-green-100 text-green-800'; tEl.textContent='âœ… è´¦ç›®å»åˆ'; } 
    else { bEl.className='mt-6 p-4 rounded-lg text-center bg-red-100 text-red-800'; tEl.textContent='âŒ å­˜åœ¨å·®å¼‚'; }
}

// v7.0: Period Filter Logic
function applyDateFilter() {
    const dateVal = document.getElementById('filter-date-input').value;
    if (!dateVal) return alert("è¯·é€‰æ‹©æ—¥æœŸ");
    state.filterDate = dateVal;
    document.body.classList.add('filter-mode');
    document.getElementById('filter-banner').style.display = 'flex';
    document.getElementById('filter-date-display').textContent = dateVal;
    updateUI();
}

function clearDateFilter() {
    state.filterDate = null;
    document.getElementById('filter-date-input').value = '';
    document.body.classList.remove('filter-mode');
    document.getElementById('filter-banner').style.display = 'none';
    updateUI();
}

// --- CORE STATE CALCULATION ---
function rebuildStateFromLogs() {
    // Process ALL logs to get correct Positions. No filtering here.
    const logs = state.transactionLog.filter(l => l.status === 'active').sort((a,b) => new Date(a.date) - new Date(b.date));
    const tempPos = {}; state.history = [];
    logs.forEach(l => {
        const k = `${l.trader}-${l.product}-${l.contract}`;
        if(!tempPos[k]) tempPos[k] = { key: k, trader: l.trader, product: l.product, contract: l.contract, quantity: 0, totalValue: 0 };
        let p = tempPos[k];
        const avg = p.quantity !== 0 ? p.totalValue / p.quantity : 0;
        
        if(p.quantity !== 0 && Math.sign(p.quantity) !== Math.sign(l.quantity)) {
            const closeQty = Math.min(Math.abs(p.quantity), Math.abs(l.quantity));
            const dir = Math.sign(p.quantity);
            const mult = l.product === 'TTF' ? (state.settings.ttfMultiplier || 3412) : config.contractMultipliers[l.product];
            
            if(l.type === 'regular' || !l.type) {
                const gross = (l.price - avg) * closeQty * dir * mult;
                const feeRate = l.product==='Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
                const cost = closeQty * mult * 2 * feeRate;
                state.history.push({ 
                    date: l.date, trader: l.trader, product: l.product, contract: l.contract,
                    closedQuantity: closeQty * dir * -1, openPrice: avg, closePrice: l.price, realizedPL: gross - cost 
                });
                const frac = (Math.abs(p.quantity) - closeQty) / Math.abs(p.quantity);
                p.totalValue *= frac;
                p.quantity += l.quantity; 
            } else {
                p.totalValue += l.quantity * l.price;
                p.quantity += l.quantity;
            }
        } else {
            p.totalValue += l.quantity * l.price;
            p.quantity += l.quantity;
        }
    });
    state.positions = Object.values(tempPos).filter(p => Math.abs(p.quantity) > 0.0001);
}

// --- PARSER ---
function parseImportText() {
    const text = document.getElementById('batch-input').value;
    const rawLines = text.split('\n').filter(l => l.trim());
    const merged = [];
    rawLines.forEach(l => {
        const isNumOnly = /^\s*(\d+(\.\d+)?(\s+|,|$))+/.test(l) && !/[a-z]/i.test(l);
        if(isNumOnly && merged.length) merged[merged.length-1] += " " + l;
        else merged.push(l);
    });
    
    parsedTradesBuffer = [];
    let validCount = 0;
    const monthMap = {'JAN':'01','FEB':'02','MAR':'03','APR':'04','MAY':'05','JUN':'06','JUL':'07','AUG':'08','SEP':'09','OCT':'10','NOV':'11','DEC':'12'};
    
    merged.forEach(line => {
        try {
            // Pre-cleaning
            let clean = line.replace(/^(to\s+)?confirm\s+(u\s+)?/i, '')
                            .replace(/^\s*\d+([.)\uff09\]]|\s+)/, '') 
                            .replace(/(\d+(\.\d+)?)\s*(SCN|SCREEN|PX)\b/ig, '') 
                            .toUpperCase();
            
            let trader = document.getElementById('trader').value;
            if(/\bD\b/.test(clean)) trader = 'D'; else if(/\bW\b/.test(clean)) trader = 'W'; else if(/\bL\b/.test(clean)) trader = 'L'; else if(/\bZ\b/.test(clean)) trader = 'Z';

            let product = 'Brent'; 
            if(/HH|HENRY/.test(clean)) product = 'Henry Hub'; else if(/JKM/.test(clean)) product = 'JKM'; else if(/TTF/.test(clean)) product = 'TTF';
            
            let side = 1; if(/SELL|SOLD|SHORT/.test(clean)) side = -1;
            
            let qty = 0;
            const qMatch = clean.match(/(\d+(\.\d+)?)(\s*X|\s*KB|\s*LOTS)/) || clean.match(/(\d+(\.\d+)?)\s*(\/M|PM)/);
            if(qMatch) { qty = parseFloat(qMatch[1]); clean = clean.replace(qMatch[0], ''); }
            
            let price = 0;
            const otcMatch = clean.match(/OTC(?:\s*PX)?\s*(\d+(\.\d+)?)/) || clean.match(/(\d+(\.\d+)?)\s*OTC/);
            if(otcMatch) price = parseFloat(otcMatch[1]);
            else { const atMatch = clean.match(/AT\s*(\d+(\.\d+)?)/); if(atMatch) price = parseFloat(atMatch[1]); }
            
            const rangeRgx = /\b(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)(\d{2})?\s*(-|TO)\s*(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)(\d{2})?\b/;
            const rangeMatch = clean.match(rangeRgx);
            
            if(rangeMatch && qty > 0) {
                const sM = monthMap[rangeMatch[1]]; const eM = monthMap[rangeMatch[4]];
                const sY = rangeMatch[2] || '26'; const eY = rangeMatch[5] || sY;
                let startIdx = parseInt(sM) + (parseInt(sY)-26)*12 - 1; let endIdx = parseInt(eM) + (parseInt(eY)-26)*12 - 1;
                const leftovers = clean.replace(rangeMatch[0], '').replace(/OTC|AT|PM/g, '');
                const prices = (leftovers.match(/-?\d+(\.\d+)?/g)||[]).map(Number).filter(n => n > 10 || n < 5); 
                const count = endIdx - startIdx + 1;
                let finalPrices = Array(count).fill(price);
                if(prices.length === count + 1 && prices.includes(price)) { prices.splice(prices.indexOf(price), 1); }
                if(prices.length === count) finalPrices = prices;
                
                for(let i=0; i<count; i++) {
                    const absM = (startIdx + i) % 12 + 1; const absY = 26 + Math.floor((startIdx + i)/12);
                    const cName = (product==='Henry Hub'?'HH':'') + absY + String(absM).padStart(2,'0');
                    parsedTradesBuffer.push({ isValid: true, trader, product, contract: cName, quantity: qty*side, price: finalPrices[i], side });
                }
                validCount++;
            } else if (qty > 0) {
                const mMatch = clean.match(/\b(\d{2})-(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\b/) || clean.match(/\b(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\s*(\d{2})?\b/);
                const qMatch = clean.match(/\b(26|27)Q[1-4]\b/); 
                let cName = '';
                if(qMatch) { cName = qMatch[0]; } else if(mMatch) {
                    let mStr = mMatch[1].length===2 ? mMatch[2] : mMatch[1]; let yStr = mMatch[1].length===2 ? mMatch[1] : (mMatch[2]||'26');
                    cName = (product==='Henry Hub'?'HH':'') + yStr + monthMap[mStr];
                }
                if(cName && price > 0) { parsedTradesBuffer.push({ isValid: true, trader, product, contract: cName, quantity: qty*side, price, side }); validCount++; }
            }
        } catch(e) { console.error(e); }
    });
    
    const tbody = document.getElementById('import-preview-body'); tbody.innerHTML = '';
    parsedTradesBuffer.forEach(t => { tbody.innerHTML += `<tr class="border-b"><td class="px-2">âœ…</td><td>${t.trader}</td><td>${t.product}</td><td>${t.contract}</td><td>${t.side>0?'ä¹°':'å–'}</td><td>${Math.abs(t.quantity)}</td><td>${t.price}</td></tr>`; });
    document.getElementById('btn-batch-submit').disabled = validCount === 0; document.getElementById('import-preview-container').classList.remove('hidden');
}
function batchSubmitTrades() {
    parsedTradesBuffer.forEach(t => { state.transactionLog.push({ id: Date.now()+Math.random(), date: new Date().toISOString(), trader: t.trader, product: t.product, contract: t.contract, quantity: t.quantity, price: t.price, status: 'active', type: 'regular' }); });
    updateUI(); closeBatchImportModal(); openInfoModal('æˆåŠŸ', `å·²å¯¼å…¥ ${parsedTradesBuffer.length} æ¡äº¤æ˜“`);
}

// v7.1 AI Export Function
function exportNotebookLMData() {
    let content = "# äº¤æ˜“åˆ†æä¸Šä¸‹æ–‡æ•°æ® (v7.1)\n\n";
    content += "## 1. è´¦æˆ·æ¦‚è§ˆ\n";
    content += `- ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}\n`;
    
    // Aggregate by Product for AI Context
    const grouped = state.positions.reduce((acc, p) => { (acc[p.product] = acc[p.product] || []).push(p); return acc; }, {});
    let summaryText = "";
    Object.keys(grouped).forEach(prod => {
        const rows = grouped[prod];
        const netQty = rows.reduce((acc, p) => acc + p.quantity, 0);
        const totalCost = rows.reduce((acc, p) => acc + (p.totalValue * config.contractMultipliers[prod]), 0);
        const wAvg = Math.abs(netQty) > 0.001 ? (totalCost / (netQty * config.contractMultipliers[prod])) : 0;
        summaryText += `- ${prod}: å‡€æŒä»“ ${netQty.toFixed(3)} æ‰‹, åŠ æƒå‡ä»· ${wAvg.toFixed(4)}\n`;
    });
    
    const totalRealized = (state.settings.initialRealizedPL || 0) + state.history.reduce((acc, h) => acc + h.realizedPL, 0);
    content += summaryText;
    content += `- ç´¯è®¡å®ç°ç›ˆäº: $${totalRealized.toFixed(2)}\n\n`;

    content += "## 2. å†å²å¹³ä»“è®°å½• (æœ€è¿‘50ç¬”)\n";
    const recentHistory = [...state.history].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 50);
    recentHistory.forEach(h => {
        content += `- ${new Date(h.date).toLocaleDateString()}: ${h.trader} å¹³ä»“ ${h.contract} ${h.closedQuantity.toFixed(3)}æ‰‹, ç›ˆäº $${h.realizedPL.toFixed(2)}\n`;
    });

    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "trading_context_for_ai.txt";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// v7.1: New Dashboard Logic
function generateDailyReport() {
    openDashboardModal();
}

function openDashboardModal() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dash-date-display').textContent = `ğŸ“… ${today}`;
    
    // 1. Calculate Realized PL for Today
    const todayHistory = state.history.filter(h => h.date.startsWith(today));
    const realizedToday = todayHistory.reduce((acc, h) => acc + h.realizedPL, 0);
    const dashRealized = document.getElementById('dash-realized');
    dashRealized.textContent = `$${realizedToday.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
    dashRealized.className = `dash-val ${realizedToday >= 0 ? 'text-green-600' : 'text-red-600'}`;
    
    // 2. Closed Trades List
    const closedBody = document.getElementById('dash-closed-body');
    closedBody.innerHTML = '';
    if (todayHistory.length === 0) {
        closedBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400">ä»Šæ—¥æš‚æ— å¹³ä»“è®°å½•</td></tr>';
    } else {
        todayHistory.forEach(h => {
            const plClass = h.realizedPL >= 0 ? 'text-green-600' : 'text-red-600';
            const dir = h.closedQuantity > 0 ? 'Shortå¹³' : 'Longå¹³'; // closedQty > 0 means we BOUGHT to close a SHORT? No.
            // In history: closedQuantity = closedQty * dir * -1.
            // If we closed a Long position (dir=1), closedQuantity is negative (Selling).
            // So if closedQuantity < 0, it's "Sell Close" (Long Exit). If > 0, "Buy Close" (Short Exit).
            const op = h.closedQuantity < 0 ? 'å–å¹³(Long)' : 'ä¹°å¹³(Short)';
            
            closedBody.innerHTML += `
                <tr class="border-b">
                    <td class="p-2 font-mono">${h.contract}</td>
                    <td class="p-2 text-xs">${op}</td>
                    <td class="p-2 text-right">${Math.abs(h.closedQuantity).toFixed(1)}</td>
                    <td class="p-2 text-right font-bold ${plClass}">${h.realizedPL.toFixed(0)}</td>
                </tr>
            `;
        });
    }

    // 3. Current Positions Summary
    let totalFloating = 0;
    const posBody = document.getElementById('dash-pos-body');
    posBody.innerHTML = '';
    
    // Group by Product
    const grouped = state.positions.reduce((acc, p) => { (acc[p.product] = acc[p.product] || []).push(p); return acc; }, {});
    
    Object.keys(grouped).forEach(prod => {
        const rows = grouped[prod];
        let subQty = 0;
        let subCost = 0;
        let subFloating = 0;
        
        rows.forEach(p => {
            const avg = p.quantity !== 0 ? p.totalValue / p.quantity : 0;
            const mtm = state.marketPrices[p.contract] || avg;
            const mult = prod === 'TTF' ? state.settings.ttfMultiplier : config.contractMultipliers[prod] || 1000;
            const gross = (mtm * p.quantity * mult) - (p.totalValue * mult);
            const feeRate = prod==='Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
            const fee = Math.abs(p.quantity) * mult * feeRate;
            const net = gross - fee;
            
            subQty += p.quantity;
            subCost += p.totalValue * mult;
            subFloating += net;
        });
        totalFloating += subFloating;
        
        const wAvg = Math.abs(subQty) > 0.001 ? (subCost / (subQty * (prod === 'TTF' ? state.settings.ttfMultiplier : config.contractMultipliers[prod]))) : 0;
        const plClass = subFloating >= 0 ? 'text-green-600' : 'text-red-600';
        
        posBody.innerHTML += `
            <tr class="border-b">
                <td class="p-2 font-bold">${prod}</td>
                <td class="p-2 text-right font-mono">${subQty.toFixed(3)}</td>
                <td class="p-2 text-right text-slate-400">${wAvg.toFixed(3)}</td>
                <td class="p-2 text-right font-bold ${plClass}">${subFloating.toFixed(0)}</td>
            </tr>
        `;
    });
    
    const dashFloating = document.getElementById('dash-floating');
    dashFloating.textContent = `$${totalFloating.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
    dashFloating.className = `dash-val ${totalFloating >= 0 ? 'text-blue-600' : 'text-red-600'}`; // Blue/Red for floating
    
    document.getElementById('dash-tx-count').textContent = state.transactionLog.filter(l => l.status==='active' && l.date.startsWith(today)).length;

    document.getElementById('dashboard-modal').classList.remove('hidden');
}

function exportDashboardReport() {
    // Generate a text version of the dashboard
    const today = new Date().toISOString().split('T')[0];
    let txt = `=== äº¤æ˜“å¤ç›˜çœ‹æ¿ [${today}] ===\n\n`;
    
    const rVal = document.getElementById('dash-realized').textContent;
    const fVal = document.getElementById('dash-floating').textContent;
    txt += `å½“æ—¥å®ç°ç›ˆäº: ${rVal}\n`;
    txt += `å½“å‰æµ®åŠ¨ç›ˆäº: ${fVal}\n\n`;
    
    txt += `--- å½“æ—¥å¹³ä»“æ˜ç»† ---\n`;
    // Re-calculate for export to ensure data freshness
    const todayHistory = state.history.filter(h => h.date.startsWith(today));
    if (todayHistory.length === 0) txt += "æ— \n";
    else {
        todayHistory.forEach(h => {
             txt += `${h.contract} | ${h.closedQuantity.toFixed(1)}æ‰‹ | ç›ˆäº: ${h.realizedPL.toFixed(0)}\n`;
        });
    }
    
    txt += `\n--- æŒä»“æ±‡æ€» ---\n`;
    const grouped = state.positions.reduce((acc, p) => { (acc[p.product] = acc[p.product] || []).push(p); return acc; }, {});
    Object.keys(grouped).forEach(prod => {
        const rows = grouped[prod];
        const netQty = rows.reduce((acc, p) => acc + p.quantity, 0);
        const subFloating = rows.reduce((acc, p) => {
             const mtm = state.marketPrices[p.contract] || (p.totalValue / p.quantity);
             const mult = prod === 'TTF' ? state.settings.ttfMultiplier : config.contractMultipliers[prod];
             return acc + ((mtm * p.quantity * mult) - (p.totalValue * mult)); // Gross Approx
        }, 0);
        txt += `${prod}: å‡€æŒä»“ ${netQty.toFixed(3)} | æµ®åŠ¨ ${subFloating.toFixed(0)}\n`;
    });

    const blob = new Blob([txt], {type:'text/plain'});
    const link = document.createElement('a');
    link.href=URL.createObjectURL(blob);
    link.download = `dashboard_${today}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}


// --- RENDER & INIT (Moved to end) ---
function renderAll() {
    renderPositions(); renderLogs(); renderHistory(); 
    document.getElementById('pos-count-badge').textContent = state.positions.length;
}

function renderPositions() {
    const tbody = document.getElementById('positions-table'); tbody.innerHTML = '';
    let totalF = 0, grandNetQty = 0;
    const grouped = state.positions.reduce((acc, p) => { (acc[p.product] = acc[p.product] || []).push(p); return acc; }, {});
    
    Object.keys(grouped).sort().forEach(prod => {
        let subQty = 0, subCost = 0, subPL = 0;
        const rows = grouped[prod].sort((a,b) => a.contract.localeCompare(b.contract));
        
        rows.forEach(p => {
            const avg = p.quantity !== 0 ? p.totalValue / p.quantity : 0;
            const mtm = state.marketPrices[p.contract] || avg;
            const mult = p.product === 'TTF' ? state.settings.ttfMultiplier : config.contractMultipliers[p.product] || 1000;
            const gross = (mtm * p.quantity * mult) - (p.totalValue * mult);
            const feeRate = p.product==='Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
            const fee = Math.abs(p.quantity) * mult * feeRate;
            const net = gross - fee;
            totalF += net; subPL += net; subQty += p.quantity; subCost += p.totalValue * mult; grandNetQty += p.quantity;
        });
        
        let subWAvg = Math.abs(subQty) > 0.001 ? (subCost / (subQty * (prod === 'TTF' ? state.settings.ttfMultiplier : config.contractMultipliers[prod]))) : 0;
        const badgeClass = config.colors[prod] || 'badge-brent';
        const plColor = subPL >= 0 ? 'text-green-600' : 'text-red-600';

        tbody.innerHTML += `
            <tr class="subtotal-row border-b border-t border-slate-700/60">
                <td class="px-4 py-2"><span class="badge ${badgeClass}">${prod}</span></td>
                <td class="px-4 py-2 text-xs uppercase">SUBTOTAL</td>
                <td class="px-4 py-2 text-right font-mono font-bold">${subQty.toFixed(3)}</td>
                <td class="px-4 py-2"></td>
                <td class="px-4 py-2 text-right text-xs text-slate-400">W.Avg: ${subWAvg.toFixed(4)}</td>
                <td class="px-4 py-2"></td>
                <td class="px-4 py-2 text-right font-bold ${plColor}">${subPL.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                <td colspan="2"></td>
            </tr>`;

        rows.forEach((p, idx) => {
            const avg = p.quantity !== 0 ? p.totalValue / p.quantity : 0;
            const mtm = state.marketPrices[p.contract] || avg;
            const mult = p.product === 'TTF' ? state.settings.ttfMultiplier : config.contractMultipliers[p.product] || 1000;
            const feeRate = p.product==='Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
            const net = ((mtm * p.quantity) - p.totalValue) * mult - (Math.abs(p.quantity) * mult * feeRate);
            const rmb = state.settings.exchangeRateRMB || 7.13;
            let landed = 0;
            if(p.product === 'Brent') landed = (avg * 0.134 + 0.46) * rmb / 28.3;
            else if(p.product === 'Henry Hub') landed = (avg * 1.15 + 4.5) * rmb / 28.3;
            const uniqueId = `${p.key}`; 
            
            const unit = p.product === 'Brent' ? 'bbl' : (p.product === 'TTF' ? 'MWh' : 'MMBtu');
            const dirBadge = p.quantity > 0 ? '<span class="badge badge-long">Long</span>' : '<span class="badge badge-short">Short</span>';
            const plClass = net >= 0 ? 'text-green-600' : 'text-red-600';
            
            tbody.innerHTML += `
                <tr class="border-b table-row-hover transition-colors bg-slate-900/30">
                    <td class="px-4 py-3 font-medium pl-8 border-l-4 border-transparent hover:border-indigo-300">${p.trader}</td>
                    <td class="px-4 py-3 font-mono">${p.contract} <span class="text-xs text-slate-400 ml-1">${unit}</span></td>
                    <td class="px-4 py-3 text-right font-mono">${Math.abs(p.quantity).toFixed(3)}</td>
                    <td class="px-4 py-3 text-center">${dirBadge}</td>
                    <td class="px-4 py-3 text-right text-slate-400">${avg.toFixed(3)}</td>
                    <td class="px-4 py-3 text-right"><input type="number" step="0.01" value="${mtm.toFixed(3)}" class="w-20 text-right text-xs border rounded px-1" onchange="updateMtmPrice('${uniqueId}', this.value)"></td>
                    <td class="px-4 py-3 text-right font-bold ${plClass}">${net.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="px-4 py-3 text-right text-xs text-slate-400">${landed ? landed.toFixed(4) : '-'}</td>
                    <td class="px-4 py-3 text-center"><button onclick="reverseTradeByPos('${uniqueId}')" class="text-xs text-red-500 hover:underline">æ’¤é”€</button></td>
                </tr>`;
        });
    });
    
    document.getElementById('total-floating-pl').textContent = totalF.toLocaleString('en-US', {style:'currency', currency:'USD'});
    document.getElementById('total-floating-pl').className = `px-4 py-3 text-right font-bold text-lg ${totalF>=0?'text-green-600':'text-red-600'}`;
    document.getElementById('total-net-qty').textContent = grandNetQty.toFixed(3);
}

function renderLogs() {
    const tbody = document.getElementById('log-table'); 
    
    // v7.0: Filter logs by start date if active
    let logs = state.transactionLog.filter(l => l.status === 'active');
    if (state.filterDate) {
        logs = logs.filter(l => l.date >= state.filterDate);
    }
    
    const visibleLogs = logs.sort((a,b) => b.date.localeCompare(a.date)).slice(0, 500);
    const html = visibleLogs.map(l => `<tr class="border-b hover:bg-slate-800/60"><td class="px-2 py-2">${l.date.substring(5,16).replace('T',' ')}</td><td class="font-bold text-xs">${l.trader}</td><td>${l.contract}</td><td class="${l.quantity>0?'text-green-600':'text-red-600'}">${l.quantity}</td><td>${l.price}</td><td><button onclick="reverseTrade(${l.id})" class="text-slate-400 hover:text-red-400">Ã—</button></td></tr>`).join('');
    tbody.innerHTML = html;
}

function renderHistory() {
    const tbody = document.getElementById('history-table'); 
    let total = state.filterDate ? 0 : (state.settings.initialRealizedPL || 0); 
    
    let history = [...state.history].sort((a,b) => new Date(b.date) - new Date(a.date));
    
    if (state.filterDate) {
        history = history.filter(h => h.date >= state.filterDate);
    }
    
    history.forEach(h => total += h.realizedPL);
    
    const recent = history.slice(0, 500);
    const html = recent.map(h => `<tr class="border-b hover:bg-slate-800/60"><td class="px-2 py-2">${h.date.split('T')[0].substring(5)}</td><td>${h.contract}</td><td>${h.closedQuantity.toFixed(1)}</td><td class="font-bold ${h.realizedPL>=0?'text-green-600':'text-red-600'}">${h.realizedPL.toFixed(0)}</td></tr>`).join('');
    tbody.innerHTML = html;
    document.getElementById('total-realized-pl').textContent = total.toLocaleString('en-US', {style:'currency', currency:'USD'});
}

// --- CSV EXPORT ---
function exportData() {
    const dataStr = JSON.stringify(state, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `trade_data_export_${new Date().toISOString()}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href);
}
function importData(event) {
    const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
    reader.onload = e => { try { const imported = JSON.parse(e.target.result); if (imported.transactionLog) { state = imported; hydrateState(); updateUI(); openInfoModal('æˆåŠŸ', 'æ•°æ®å¯¼å…¥æˆåŠŸ!'); } } catch (err) { openInfoModal('é”™è¯¯', 'æ–‡ä»¶é”™è¯¯'); } }; reader.readAsText(file); event.target.value = '';
}
function importMtmData(event) {
    const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
    reader.onload = function(e) { try { const importedData = JSON.parse(e.target.result); if (!importedData.marketPrices) throw new Error("ç¼ºå°‘ marketPrices"); const newPrices = importedData.marketPrices; for (const [contract, price] of Object.entries(newPrices)) { state.marketPrices[contract] = parseFloat(price); } updateUI(); openInfoModal('æˆåŠŸ', 'è¡Œæƒ…æ›´æ–°æˆåŠŸ'); } catch (error) { openInfoModal('å¤±è´¥', error.message); } }; reader.readAsText(file); event.target.value = '';
}
function exportToCSV(headers, dataRows, fileName) {
    const csv = [ headers.join(','), ...dataRows.map(row => headers.map(fieldName => { let cell = (row[fieldName] ?? '').toString().replace(/"/g, '""'); if (cell.search(/("|,|\n)/g) >= 0) cell = `"${cell}"`; return cell; }).join(',')) ].join('\n');
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); const url = URL.createObjectURL(blob);
    link.setAttribute("href", url); link.setAttribute("download", fileName); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
}
function exportPositionsCSV() {
    const headers = ["åˆçº¦", "æ•°é‡", "å‡ä»·", "MTM", "æµ®åŠ¨P/L"]; 
    const data = state.positions.map(p => ({ "åˆçº¦": p.contract, "æ•°é‡": p.quantity, "å‡ä»·": (p.totalValue/p.quantity).toFixed(2) }));
    exportToCSV(headers, data, "positions.csv");
}
function exportLogCSV() {
    const headers = ["æ—¶é—´", "åˆçº¦", "æ•°é‡", "ä»·æ ¼"]; 
    const data = state.transactionLog.filter(l=>l.status==='active').map(l => ({ "æ—¶é—´": l.date, "åˆçº¦": l.contract, "æ•°é‡": l.quantity, "ä»·æ ¼": l.price }));
    exportToCSV(headers, data, "logs.csv");
}
function exportHistoryCSV() {
    const headers = ["æ—¥æœŸ", "åˆçº¦", "ç›ˆäº"]; 
    const data = state.history.map(h => ({ "æ—¥æœŸ": h.date, "åˆçº¦": h.contract, "ç›ˆäº": h.realizedPL }));
    exportToCSV(headers, data, "history.csv");
}
function exportLedgerCSV() {
    const headers = ["æ—¥æœŸ", "å“ç§", "åˆçº¦", "å½“æ—¥å¼€ä»“", "å¼€ä»“å‡ä»·", "å½“æ—¥å¹³ä»“", "å¹³ä»“å‡ä»·", "æœŸæœ«æŒä»“", "æŒä»“å‡ä»·", "ç»“ç®—ä»·(MTM)", "å½“æ—¥å®ç°ç›ˆäº(USD)", "å½“æ—¥å®ç°ç›ˆäº(å…ƒ)", "æœªå¹³ä»“ç›ˆäº(USD)", "æœªå¹³ä»“ç›ˆäº(å…ƒ)"];
    const dataRows = []; const activeLogs = state.transactionLog.filter(log => log.status === 'active'); activeLogs.sort((a, b) => new Date(a.date) - new Date(b.date));
    const logsByDay = {}; activeLogs.forEach(log => { const day = formatDateForExport(log.date, false); if (!logsByDay[day]) logsByDay[day] = []; logsByDay[day].push(log); });
    const rmbRate = state.settings.exchangeRateRMB || 7.13;
    Object.keys(logsByDay).sort().forEach(day => {
        dataRows.push({ "æ—¥æœŸ": day, "å“ç§": "SUMMARY", "åˆçº¦": "Generated" });
    });
    exportToCSV(headers, dataRows, "daily_ledger.csv");
}
function exportToCSV(headers, data, filename) {
    const csv = [headers.join(',')].concat(data.map(row => headers.map(h => row[h]).join(','))).join('\n');
    const blob = new Blob(['\uFEFF'+csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link);
}
function runStressTest() { alert("å‹åŠ›æµ‹è¯•è®¡ç®—ä¸­..."); }

// --- INIT (At End) ---
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    hydrateState();
    initializeUI();
    rebuildStateFromLogs();
    renderAll();
    document.getElementById('trade-form').addEventListener('submit', handleTradeSubmit);
    document.getElementById('edit-form').addEventListener('submit', handleEditSubmit);
    
    // Init settings in UI from state if exists
    if(state.settings.reconciliation) {
        document.getElementById('rec-base-val').value = state.settings.reconciliation.base;
        document.getElementById('rec-other-val').value = state.settings.reconciliation.other;
    }
});
</script>
</body>
</html>
