<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆçº¦äº¤æ˜“åˆ†æç»ˆç«¯ v6.7 (æ€§èƒ½æè‡´ä¼˜åŒ–ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 50; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; }
        
        .badge { display: inline-block; padding: 0.25em 0.6em; font-size: 0.75em; font-weight: 700; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 0.25rem; }
        .badge-brent { background-color: #dbeafe; color: #1e40af; }
        .badge-hh { background-color: #dcfce7; color: #166534; }
        .badge-jkm { background-color: #ffedd5; color: #9a3412; }
        .badge-ttf { background-color: #f3e8ff; color: #6b21a8; }
        .badge-long { background-color: #ecfdf5; color: #15803d; border: 1px solid #86efac; }
        .badge-short { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fca5a5; }
        
        .table-row-hover:hover { background-color: #f8fafc; }
        .reconcile-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-size: 0.875rem; }
        .subtotal-row { background-color: #f1f5f9; font-weight: 600; color: #475569; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-6 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 tracking-tight">åˆçº¦äº¤æ˜“åˆ†æç»ˆç«¯ v6.7</h1>
            <p class="text-gray-500 mt-2 font-medium">æ€§èƒ½æè‡´ä¼˜åŒ–ç‰ˆï¼šDOM ç¼“å†²æ¸²æŸ“ | æé€Ÿå¯¼å…¥ | 500æ¡æ˜¾ç¤ºé™åˆ¶</p>
        </header>
        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left Column: Controls (4 cols) -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Trade Entry Form -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="text-lg font-bold mb-4 border-b pb-3 flex items-center text-gray-700"><span>ğŸ“ è®°å½•äº¤æ˜“</span></h2>
                    <button onclick="openBatchImportModal()" class="w-full mb-5 bg-indigo-600 text-white py-2.5 px-4 rounded-lg hover:bg-indigo-700 transition duration-200 flex items-center justify-center gap-2 font-medium shadow-sm active:transform active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                        æ™ºèƒ½æ–‡æœ¬æ‰¹é‡å¯¼å…¥ (æé€Ÿç‰ˆ)
                    </button>
                    <div class="relative flex py-3 items-center"><div class="flex-grow border-t border-gray-200"></div><span class="flex-shrink-0 mx-4 text-gray-400 text-xs uppercase font-semibold">æ‰‹åŠ¨å½•å…¥</span><div class="flex-grow border-t border-gray-200"></div></div>
                    <form id="trade-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs font-semibold text-gray-500 uppercase mb-1">äº¤æ˜“å‘˜</label><select id="trader" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-sm"><option>W</option><option>L</option><option>Z</option><option>D</option></select></div>
                            <div><label class="block text-xs font-semibold text-gray-500 uppercase mb-1">å“ç§</label><select id="product" onchange="updateContractOptions()" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-sm"><option value="Brent">Brent</option><option value="Henry Hub">Henry Hub</option><option value="JKM">JKM</option><option value="TTF">TTF</option></select></div>
                        </div>
                        <div><label class="block text-xs font-semibold text-gray-500 uppercase mb-1">åˆçº¦</label><select id="contract" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-sm"></select></div>
                        <div><label class="block text-xs font-semibold text-gray-500 uppercase mb-1">äº¤æ˜“ç±»å‹</label><select id="trade-type" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-sm"><option value="regular">å¸¸è§„äº¤æ˜“ (è®¡å…¥ç›ˆäº)</option><option value="adjustment">æˆæœ¬è°ƒæ•´ (ä¼˜åŒ–æˆæœ¬)</option></select></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs font-semibold text-gray-500 uppercase mb-1">æ•°é‡ (è´Ÿ=å–)</label><input type="number" id="quantity" step="0.001" placeholder="-10" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-sm" required></div>
                            <div><label class="block text-xs font-semibold text-gray-500 uppercase mb-1">ä»·æ ¼</label><input type="number" step="any" id="price" placeholder="60.00" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-sm" required></div>
                        </div>
                        <button type="submit" class="w-full bg-slate-800 text-white py-2 px-4 rounded-md hover:bg-slate-900 transition duration-200 font-medium">æäº¤äº¤æ˜“</button>
                    </form>
                </div>
                
                <!-- Settings -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="text-lg font-bold mb-4 border-b pb-3 text-gray-700">âš™ï¸ å‚æ•°è®¾ç½®</h2>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-2 items-center"><label class="text-sm text-gray-600">Brent è´¹ç”¨</label><input type="number" step="0.01" id="commission-brent" onchange="updateSettings()" class="text-right w-full px-2 py-1 bg-gray-50 border rounded text-sm"></div>
                        <div class="grid grid-cols-2 gap-2 items-center"><label class="text-sm text-gray-600">Gas(HH/JKM)</label><input type="number" step="0.0001" id="commission-hh" onchange="updateSettings()" class="text-right w-full px-2 py-1 bg-gray-50 border rounded text-sm"></div>
                        <div class="grid grid-cols-2 gap-2 items-center"><label class="text-sm text-purple-700 font-medium">TTF æ¢ç®—</label><input type="number" step="0.01" id="ttf-multiplier" onchange="updateSettings()" class="text-right w-full px-2 py-1 bg-purple-50 border border-purple-200 rounded text-sm"></div>
                        <div class="grid grid-cols-2 gap-2 items-center"><label class="text-sm text-gray-600">USD/CNY</label><input type="number" step="0.01" id="exchange-rate-rmb" onchange="updateSettings()" class="text-right w-full px-2 py-1 bg-gray-50 border rounded text-sm"></div>
                        <div class="grid grid-cols-2 gap-2 items-center"><label class="text-sm text-gray-600">æœŸåˆç›ˆäº</label><input type="number" step="any" id="initial-realized-pl" onchange="updateSettings()" class="text-right w-full px-2 py-1 bg-gray-50 border rounded text-sm"></div>
                        <div class="border-t pt-2 mt-2"></div>
                        <div class="grid grid-cols-2 gap-2 items-center"><label class="text-sm text-yellow-700 font-medium">å¯¹è´¦åŸºå‡†é‡‘</label><input type="number" step="any" id="rec-base-val" onchange="updateSettings()" class="text-right w-full px-2 py-1 bg-yellow-50 border border-yellow-200 rounded text-sm"></div>
                        <div class="grid grid-cols-2 gap-2 items-center"><label class="text-sm text-yellow-700 font-medium">å¯¹è´¦è°ƒèŠ‚é¡¹</label><input type="number" step="any" id="rec-other-val" onchange="updateSettings()" class="text-right w-full px-2 py-1 bg-yellow-50 border border-yellow-200 rounded text-sm"></div>
                    </div>
                </div>

                <!-- AI Interaction -->
                <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-6 rounded-xl shadow-sm border border-indigo-100">
                    <h2 class="text-lg font-bold mb-2 text-indigo-900 flex items-center gap-2">ğŸ¤– AI åä½œ (NotebookLM)</h2>
                    <button onclick="exportNotebookLMData()" class="w-full bg-white text-indigo-600 border border-indigo-200 py-2 px-4 rounded-md hover:bg-indigo-50 transition font-medium flex items-center justify-center gap-2 text-sm">ç”Ÿæˆè¯­æ–™æ–‡ä»¶ (.txt)</button>
                </div>

                <!-- Data Management -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="text-lg font-bold mb-4 border-b pb-3 text-gray-700">ğŸ’¾ æ•°æ®ä¸æŠ¥è¡¨</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="exportData()" class="bg-gray-100 text-gray-700 py-2 px-3 rounded hover:bg-gray-200 text-xs">å¤‡ä»½æ•°æ®</button>
                        <label for="import-file" class="cursor-pointer bg-gray-100 text-gray-700 py-2 px-3 rounded hover:bg-gray-200 text-xs text-center block">æ¢å¤æ•°æ®<input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)"></label>
                        <label for="import-mtm-file" class="col-span-2 cursor-pointer bg-teal-50 text-teal-700 border border-teal-200 py-2 px-3 rounded hover:bg-teal-100 text-xs text-center flex items-center justify-center gap-1">ğŸ“ˆ æ›´æ–°è¡Œæƒ… (JSON)<input type="file" id="import-mtm-file" class="hidden" accept=".json" onchange="importMtmData(event)"></label>
                    </div>
                    <div class="mt-4 space-y-2">
                        <button onclick="exportLedgerCSV()" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 text-sm font-medium">å¯¼å‡ºé€æ—¥å°è´¦ (CSV)</button>
                        <button onclick="openReconcileModal()" class="w-full bg-amber-500 text-white py-2 px-4 rounded hover:bg-amber-600 text-sm font-medium flex items-center justify-center gap-2">âš–ï¸ èµ„é‡‘å¯¹è´¦åŠ©æ‰‹</button>
                        <button onclick="generateDailyReport()" class="w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700 text-sm font-medium">ğŸ“ ä»Šæ—¥æ—¥æŠ¥æ‘˜è¦</button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Data (8 cols) -->
            <div class="lg:col-span-8 space-y-6">
                <!-- Stress Test -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="text-lg font-bold mb-4 text-gray-700">âš¡ å‹åŠ›æµ‹è¯•</h2>
                    <div class="flex gap-4 items-end">
                        <div class="flex-1"><label class="block text-xs text-gray-500 mb-1">Brent å˜åŠ¨ ($)</label><input type="number" step="any" id="brent-scenario" placeholder="+5.0" class="w-full p-2 border rounded"></div>
                        <div class="flex-1"><label class="block text-xs text-gray-500 mb-1">Gas å˜åŠ¨ ($)</label><input type="number" step="any" id="hh-scenario" placeholder="-0.5" class="w-full p-2 border rounded"></div>
                        <button onclick="runStressTest()" class="bg-gray-800 text-white px-6 py-2 rounded hover:bg-gray-700 h-10">è®¡ç®—</button>
                    </div>
                    <div id="stress-test-result" class="mt-4 p-3 bg-gray-50 rounded hidden text-center text-sm">
                        <span class="font-medium">é¢„è®¡ P/L å˜åŠ¨: <span id="pl-change" class="font-bold"></span></span>
                        <span class="mx-4 text-gray-300">|</span>
                        <span class="font-medium">æ–°æµ®åŠ¨ P/L: <span id="new-total-pl" class="font-bold"></span></span>
                    </div>
                </div>

                <!-- Current Positions -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            ğŸš€ å½“å‰æŒä»“
                            <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full" id="pos-count-badge">0</span>
                        </h2>
                        <div class="flex gap-2">
                            <input type="text" id="search-positions" onkeyup="filterTable('search-positions', 'positions-table')" placeholder="æœç´¢..." class="px-3 py-1 border rounded text-sm w-40">
                            <button onclick="exportPositionsCSV()" class="text-blue-600 hover:bg-blue-50 px-3 py-1 rounded text-sm font-medium transition">å¯¼å‡º CSV</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto rounded-lg border border-gray-200">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-3">å“ç§</th><th class="px-4 py-3">åˆçº¦</th><th class="px-4 py-3 text-right">æ•°é‡</th><th class="px-4 py-3 text-center">æ–¹å‘</th><th class="px-4 py-3 text-right">æŒä»“å‡ä»·</th><th class="px-4 py-3 text-right">MTM</th><th class="px-4 py-3 text-right">æµ®åŠ¨ P/L</th><th class="px-4 py-3 text-right">åˆ°å²¸ä»·</th><th class="px-4 py-3 text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="positions-table" class="divide-y divide-gray-100"></tbody>
                            <tfoot class="bg-gray-50 font-semibold text-gray-900">
                                <tr><td colspan="6" class="text-right px-4 py-3">æ€»è®¡æµ®åŠ¨ç›ˆäº</td><td id="total-floating-pl" class="px-4 py-3 text-right">0.00</td><td colspan="2"></td></tr>
                                <tr><td colspan="6" class="text-right px-4 py-3">æ€»å‡€æŒä»“é‡</td><td id="total-net-qty" class="px-4 py-3 text-right">0.000</td><td colspan="2"></td></tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <!-- Logs & History -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-700">ğŸ“œ äº¤æ˜“æ—¥å¿— (æœ€è¿‘500æ¡)</h3><button onclick="exportLogCSV()" class="text-xs text-blue-600 hover:underline">å¯¼å‡º</button></div>
                        <input type="text" id="search-log" onkeyup="filterTable('search-log', 'log-table')" placeholder="æœç´¢..." class="w-full px-3 py-1 border rounded text-xs mb-2">
                        <div class="overflow-y-auto max-h-64"><table class="w-full text-xs text-left text-gray-500"><thead class="sticky top-0 bg-gray-50"><tr><th class="px-2 py-2">æ—¶é—´</th><th>åˆçº¦</th><th>æ•°é‡</th><th>ä»·æ ¼</th><th>æ“ä½œ</th></tr></thead><tbody id="log-table"></tbody></table></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-700">ğŸ å†å²å¹³ä»“ (æœ€è¿‘500æ¡)</h3><button onclick="exportHistoryCSV()" class="text-xs text-blue-600 hover:underline">å¯¼å‡º</button></div>
                        <input type="text" id="search-history" onkeyup="filterTable('search-history', 'history-table')" placeholder="æœç´¢..." class="w-full px-3 py-1 border rounded text-xs mb-2">
                        <div class="overflow-y-auto max-h-64"><table class="w-full text-xs text-left text-gray-500"><thead class="sticky top-0 bg-gray-50"><tr><th class="px-2 py-2">æ—¥æœŸ</th><th>åˆçº¦</th><th>å¹³ä»“é‡</th><th>ç›ˆäº</th></tr></thead><tbody id="history-table"></tbody><tfoot class="sticky bottom-0 bg-gray-50 font-bold"><tr><td colspan="3" class="text-right px-2">ç´¯è®¡</td><td id="total-realized-pl">0.00</td></tr></tfoot></table></div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="text-lg font-bold mb-4 border-b pb-2 text-gray-700">ğŸ“Š æ•°æ®å¯è§†åŒ–</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><h3 class="text-sm font-medium text-center mb-2">æŒä»“å¸‚å€¼ç»“æ„</h3><div class="chart-container"><canvas id="position-structure-chart"></canvas></div></div>
                        <div><h3 class="text-sm font-medium text-center mb-2">ç´¯è®¡ç›ˆäºæ›²çº¿</h3><div class="chart-container"><canvas id="realized-pl-chart"></canvas></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="edit-modal" class="modal-backdrop hidden"><div class="modal-content"><h2 class="text-xl font-bold mb-4">ç¼–è¾‘æŒä»“</h2><form id="edit-form" class="space-y-4"><input type="hidden" id="edit-index"><label class="block text-sm">æ•°é‡<input type="number" id="edit-quantity" class="w-full border p-2 rounded" required></label><label class="block text-sm">å‡ä»·<input type="number" step="any" id="edit-price" class="w-full border p-2 rounded" required></label><div class="flex justify-end gap-2"><button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-200 rounded">å–æ¶ˆ</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">ä¿å­˜</button></div></form></div></div>
    <div id="action-confirm-modal" class="modal-backdrop hidden"><div class="modal-content text-center"><h2 id="confirm-title" class="text-xl font-bold mb-4"></h2><p id="confirm-body" class="mb-6 text-gray-600"></p><div class="flex justify-center gap-4"><button id="confirm-cancel-btn" type="button" onclick="closeActionConfirmModal()" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md hover:bg-gray-400">å–æ¶ˆ</button><button id="confirm-action-btn" type="button" class="bg-red-600 text-white py-2 px-6 rounded-md hover:bg-red-700">ç¡®è®¤</button></div></div></div>
    <div id="report-modal" class="modal-backdrop hidden"><div class="modal-content"><h2 class="text-xl font-bold mb-4">ä»Šæ—¥æ—¥æŠ¥</h2><div id="daily-report-content" class="report-text mb-4 text-sm bg-gray-50 p-4 rounded"></div><div class="flex justify-end gap-2"><button type="button" onclick="closeReportModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">å…³é—­</button><button type="button" onclick="copyReportToClipboard()" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">å¤åˆ¶</button></div></div></div>
    <div id="reconcile-modal" class="modal-backdrop hidden">
        <div class="modal-content max-w-2xl w-full">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><span class="text-yellow-600">âš–ï¸</span> èµ„é‡‘å¯¹è´¦åŠ©æ‰‹</h2>
            <p class="text-sm text-gray-600 mb-6 bg-yellow-50 p-3 rounded border border-yellow-200">æ ¸å¯¹å…¬å¼ï¼š<b>æ°´å•æ€»ç›ˆäº</b> â‰ˆ <b>(Appç´¯è®¡å®ç°P/L + Appæµ®åŠ¨å‡€P/L)</b> - <b>è°ƒèŠ‚é¡¹</b></p>
            <div class="space-y-4">
                <div class="reconcile-row"><label class="font-medium w-1/3">App ç´¯è®¡å®ç°ç›ˆäº:</label><span id="rec-app-realized" class="font-mono text-gray-800"></span></div>
                <div class="reconcile-row"><label class="font-medium w-1/3">App æµ®åŠ¨å‡€ç›ˆäº:</label><span id="rec-app-floating" class="font-mono text-gray-800"></span></div>
                <hr class="border-gray-200">
                <div class="reconcile-row"><label class="font-medium w-1/3">â– å¯¹è´¦åŸºå‡†é‡‘:</label><input type="number" id="modal-rec-base" class="reconcile-input bg-gray-100 cursor-not-allowed" readonly></div>
                <div class="reconcile-row"><label class="font-medium w-1/3">â– å¯¹è´¦è°ƒèŠ‚é¡¹:</label><input type="number" id="modal-rec-other" class="reconcile-input bg-gray-100 cursor-not-allowed" readonly></div>
                <div class="text-xs text-gray-400 text-right mb-2">* è¯·åœ¨â€œå…¨å±€è´¹ç”¨è®¾ç½®â€ä¸­ä¿®æ”¹åŸºå‡†é‡‘ä¸è°ƒèŠ‚é¡¹</div>
                <div class="reconcile-row bg-gray-100 p-2 rounded"><label class="font-bold w-1/3 text-gray-700">App è®¡ç®—å‡€å€¼:</label><span id="rec-app-net" class="font-bold font-mono text-lg"></span></div>
                <hr class="border-gray-300 border-dashed my-4">
                <div class="reconcile-row"><label class="font-bold w-1/3 text-blue-800">ğŸ“ æ°´å• Total P/L (è¾“å…¥):</label><input type="number" id="rec-statement-val" class="reconcile-input border-blue-300 focus:ring-blue-500" placeholder="è¾“å…¥æ°´å•Xåˆ—æ€»å’Œ" onkeyup="calcReconcile()"></div>
                <div class="mt-6 p-4 rounded-lg text-center" id="rec-result-box"><div class="text-sm text-gray-500 mb-1">å·®å¼‚é‡‘é¢ (æ°´å• - App)</div><div id="rec-diff-val" class="text-3xl font-bold font-mono">0.00</div><div id="rec-status-text" class="text-sm font-semibold mt-2"></div></div>
            </div>
            <div class="flex justify-end space-x-3 mt-6"><button onclick="closeReconcileModal()" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md hover:bg-gray-400">å…³é—­</button></div>
        </div>
    </div>
    <div id="batch-import-modal" class="modal-backdrop hidden">
        <div class="modal-content max-w-4xl w-full">
            <h2 class="text-xl font-bold mb-2">æ™ºèƒ½æ–‡æœ¬æ‰¹é‡å¯¼å…¥ (æé€Ÿç‰ˆ)</h2>
            <p class="text-xs text-gray-500 mb-4">æ”¯æŒ: 1) Sold 200x Brent May26 | 50x pm Jul26-Dec26 | Bought TTF 26Q4 | D sold ...</p>
            <textarea id="batch-input" rows="12" class="w-full p-3 border border-gray-300 rounded-md font-mono text-sm focus:ring-2 focus:ring-indigo-500" placeholder="åœ¨æ­¤ç²˜è´´äº¤æ˜“æ–‡æœ¬..."></textarea>
            <div class="flex justify-end space-x-3 my-4"><button onclick="parseImportText()" class="bg-indigo-600 text-white py-2 px-6 rounded hover:bg-indigo-700">è§£æé¢„è§ˆ</button></div>
            <div id="import-preview-container" class="hidden">
                <div class="overflow-x-auto border border-gray-200 rounded-md max-h-64"><table class="w-full text-xs text-left"><thead class="bg-gray-50 sticky top-0"><tr><th class="px-4 py-2">çŠ¶æ€</th><th>äº¤æ˜“å‘˜</th><th>å“ç§</th><th>åˆçº¦</th><th>æ–¹å‘</th><th>æ•°é‡</th><th>ä»·æ ¼</th></tr></thead><tbody id="import-preview-body"></tbody></table></div>
                <div class="mt-4 flex justify-between items-center"><span id="import-summary" class="text-sm font-bold text-gray-700"></span><div class="space-x-3"><button onclick="closeBatchImportModal()" class="bg-gray-300 px-4 py-2 rounded">å–æ¶ˆ</button><button onclick="batchSubmitTrades()" id="btn-batch-submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">ç¡®è®¤æäº¤</button></div></div>
            </div>
        </div>
    </div>

<script>
// ==================== 1. CONFIGURATION & STATE ====================
function generateContracts(start, end) {
    return ['2602','2603','2604','2605','2606','2607','2608','2609','2610','2611','2612','2701','2702','2703','26Q4','27Q1'];
}
const config = {
    traders: ['W', 'L', 'Z', 'D'], 
    contracts: {
        'Brent': generateContracts(),
        'Henry Hub': ['HH2511','HH2512','HH2601','HH2607'],
        'JKM': generateContracts(),
        'TTF': generateContracts()
    },
    contractMultipliers: { 'Brent': 1000, 'Henry Hub': 10000, 'JKM': 10000, 'TTF': 10000 },
    colors: { 'Brent': 'badge-brent', 'Henry Hub': 'badge-hh', 'JKM': 'badge-jkm', 'TTF': 'badge-ttf' }
};

let state = {
    positions: [], history: [], transactionLog: [], marketPrices: {},
    settings: { fees: { brentPerBbl: 0, hhPerMMBtu: 0 }, exchangeRateRMB: 7.13, initialRealizedPL: 0, reconciliation: { base: 156170, other: 45800 }, ttfMultiplier: 3412 }
};
let positionChart = null, plChart = null, parsedTradesBuffer = [];

// ==================== 2. BASE UTILITIES (Hoist First) ====================
function getPricePrecision(product) { return product === 'Henry Hub' ? 4 : 2; }
function formatPrice(price, product) { if (typeof price !== 'number') return 'N/A'; return price.toFixed(getPricePrecision(product)); }
function saveState() { localStorage.setItem('tradeAppState', JSON.stringify(state)); }
function loadState() { const s = localStorage.getItem('tradeAppState'); if (s) state = JSON.parse(s); }
function formatDateForExport(isoString, includeTime = true) { 
    try { const date = new Date(isoString); const YYYY = date.getFullYear(); const MM = String(date.getMonth() + 1).padStart(2, '0'); const DD = String(date.getDate()).padStart(2, '0'); if (!includeTime) return `${YYYY}-${MM}-${DD}`; const hh = String(date.getHours()).padStart(2, '0'); const mm = String(date.getMinutes()).padStart(2, '0'); const ss = String(date.getSeconds()).padStart(2, '0'); return `${YYYY}-${MM}-${DD} ${hh}:${mm}:${ss}`; } catch(e) { return isoString; }
}

// ==================== 3. MODAL CONTROLS ====================
function openInfoModal(t, b) { document.getElementById('confirm-title').textContent = t; document.getElementById('confirm-body').textContent = b; document.getElementById('confirm-action-btn').onclick = closeActionConfirmModal; document.getElementById('confirm-action-btn').textContent = 'å¥½çš„'; document.getElementById('confirm-cancel-btn').classList.add('hidden'); document.getElementById('action-confirm-modal').classList.remove('hidden'); }
function openConfirmModal(t, b, fn) { document.getElementById('confirm-title').textContent = t; document.getElementById('confirm-body').textContent = b; document.getElementById('confirm-action-btn').onclick = fn; document.getElementById('confirm-action-btn').textContent = 'ç¡®è®¤'; document.getElementById('confirm-cancel-btn').classList.remove('hidden'); document.getElementById('action-confirm-modal').classList.remove('hidden'); }
function closeActionConfirmModal() { document.getElementById('action-confirm-modal').classList.add('hidden'); }
function openEditModal(i) { document.getElementById('edit-index').value = i; document.getElementById('edit-modal').classList.remove('hidden'); }
function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }
function handleEditSubmit(e) { e.preventDefault(); openInfoModal('æç¤º', 'ä¸ºä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œè¯·é€šè¿‡æ’¤é”€åŠŸèƒ½ä¿®æ”¹äº¤æ˜“ã€‚'); closeEditModal(); }
function openBatchImportModal() { document.getElementById('batch-input').value = ''; document.getElementById('import-preview-container').classList.add('hidden'); document.getElementById('batch-import-modal').classList.remove('hidden'); }
function closeBatchImportModal() { document.getElementById('batch-import-modal').classList.add('hidden'); parsedTradesBuffer = []; }
function openReconcileModal() {
    const historyPL = state.history.reduce((a,b)=>a+b.realizedPL,0); const totalR = (state.settings.initialRealizedPL||0)+historyPL;
    let totalF = 0; state.positions.forEach(p=>{ 
        const c=state.marketPrices[p.contract]||(p.totalValue/p.quantity); 
        const mult = p.product === 'TTF' ? state.settings.ttfMultiplier : config.contractMultipliers[p.product];
        const g=(c*p.quantity*mult)-(p.totalValue*mult); 
        const f=p.product==='Brent'?state.settings.fees.brentPerBbl:state.settings.fees.hhPerMMBtu; 
        totalF+=(g-(Math.abs(p.quantity)*mult*f)); 
    });
    
    const recSettings = state.settings.reconciliation || { base: 156170, other: 45800 };
    document.getElementById('modal-rec-base').value = recSettings.base;
    document.getElementById('modal-rec-other').value = recSettings.other;
    
    document.getElementById('rec-app-realized').textContent = `$${totalR.toFixed(2)}`; document.getElementById('rec-app-floating').textContent = `$${totalF.toFixed(2)}`;
    calcReconcile(); document.getElementById('reconcile-modal').classList.remove('hidden');
}
function closeReconcileModal() { document.getElementById('reconcile-modal').classList.add('hidden'); }
function closeReportModal() { document.getElementById('report-modal').classList.add('hidden'); }
function copyReportToClipboard() { navigator.clipboard.writeText(document.getElementById('daily-report-content').textContent); alert('å·²å¤åˆ¶'); }

// ==================== 4. CORE LOGIC ====================
function hydrateState() {
    if(!state.positions) state.positions=[]; if(!state.history) state.history=[]; 
    if(!state.transactionLog) state.transactionLog=[]; if(!state.marketPrices) state.marketPrices={};
    if(!state.settings) state.settings={ fees:{brentPerBbl:0, hhPerMMBtu:0}, exchangeRateRMB:7.13, initialRealizedPL:0, reconciliation: { base: 156170, other: 45800 }, ttfMultiplier: 3412 };
    if(!state.settings.reconciliation) state.settings.reconciliation = { base: 156170, other: 45800 }; 
    if(!state.settings.ttfMultiplier) state.settings.ttfMultiplier = 3412;
    state.transactionLog.forEach(l => { if(!l.id) l.id=Date.now()+Math.random(); if(!l.status) l.status='active'; });
}

function initializeUI() {
    updateContractOptions();
    document.getElementById('commission-brent').value = state.settings.fees.brentPerBbl;
    document.getElementById('commission-hh').value = state.settings.fees.hhPerMMBtu;
    document.getElementById('exchange-rate-rmb').value = state.settings.exchangeRateRMB;
    document.getElementById('initial-realized-pl').value = state.settings.initialRealizedPL;
    document.getElementById('rec-base-val').value = state.settings.reconciliation.base;
    document.getElementById('rec-other-val').value = state.settings.reconciliation.other;
    document.getElementById('ttf-multiplier').value = state.settings.ttfMultiplier;
}

function rebuildStateFromLogs() {
    const logs = state.transactionLog.filter(l => l.status === 'active').sort((a,b) => new Date(a.date) - new Date(b.date));
    const tempPos = {}; state.history = [];
    logs.forEach(l => {
        const k = `${l.trader}-${l.product}-${l.contract}`;
        if(!tempPos[k]) tempPos[k] = { key: k, trader: l.trader, product: l.product, contract: l.contract, quantity: 0, totalValue: 0 };
        let p = tempPos[k];
        const avg = p.quantity !== 0 ? p.totalValue / p.quantity : 0;
        
        if(p.quantity !== 0 && Math.sign(p.quantity) !== Math.sign(l.quantity)) {
            const closeQty = Math.min(Math.abs(p.quantity), Math.abs(l.quantity));
            const dir = Math.sign(p.quantity);
            const mult = l.product === 'TTF' ? state.settings.ttfMultiplier : config.contractMultipliers[l.product];
            
            if(l.type === 'regular' || !l.type) {
                const gross = (l.price - avg) * closeQty * dir * mult;
                const feeRate = l.product==='Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
                const cost = closeQty * mult * 2 * feeRate;
                state.history.push({ date: l.date, trader: l.trader, product: l.product, contract: l.contract, closedQuantity: closeQty * dir * -1, openPrice: avg, closePrice: l.price, realizedPL: gross - cost });
                const frac = (Math.abs(p.quantity) - closeQty) / Math.abs(p.quantity);
                p.totalValue *= frac;
                p.quantity += l.quantity; 
            } else {
                p.totalValue += l.quantity * l.price;
                p.quantity += l.quantity;
            }
        } else {
            p.totalValue += l.quantity * l.price;
            p.quantity += l.quantity;
        }
    });
    state.positions = Object.values(tempPos).filter(p => Math.abs(p.quantity) > 0.0001);
}

// --- ACTIONS ---
function handleTradeSubmit(e) {
    e.preventDefault();
    const t = document.getElementById('trader').value;
    const p = document.getElementById('product').value;
    const c = document.getElementById('contract').value;
    const q = parseFloat(document.getElementById('quantity').value);
    const pr = parseFloat(document.getElementById('price').value);
    const ty = document.getElementById('trade-type').value;
    if(isNaN(q) || isNaN(pr)) return openInfoModal("é”™è¯¯", "è¯·è¾“å…¥æœ‰æ•ˆæ•°å€¼");
    addTransaction(t, p, c, q, pr, ty);
    document.getElementById('trade-form').reset();
}

function addTransaction(trader, product, contract, qty, price, type) {
    state.transactionLog.push({ id: Date.now()+Math.random(), date: new Date().toISOString(), trader, product, contract, quantity: qty, price, status:'active', type });
    updateUI();
}

function updateUI() { rebuildStateFromLogs(); saveState(); renderAll(); }

function reverseTrade(id) {
    const log = state.transactionLog.find(l => l.id === id);
    if(log && confirm(`ç¡®è®¤æ’¤é”€ ${log.contract} ${log.quantity} @ ${log.price}?`)) {
        log.status = 'reversed'; updateUI();
    }
}
function reverseTradeByPos(key) {
    const log = state.transactionLog.slice().reverse().find(l => `${l.trader}-${l.product}-${l.contract}` === key && l.status === 'active');
    if(log) reverseTrade(log.id);
    else alert("æœªæ‰¾åˆ°å¯æ’¤é”€çš„äº¤æ˜“è®°å½•");
}

function updateSettings() {
    state.settings.fees.brentPerBbl = parseFloat(document.getElementById('commission-brent').value)||0;
    state.settings.fees.hhPerMMBtu = parseFloat(document.getElementById('commission-hh').value)||0;
    state.settings.exchangeRateRMB = parseFloat(document.getElementById('exchange-rate-rmb').value)||7.13;
    state.settings.initialRealizedPL = parseFloat(document.getElementById('initial-realized-pl').value)||0;
    state.settings.reconciliation = {
        base: parseFloat(document.getElementById('rec-base-val').value)||0,
        other: parseFloat(document.getElementById('rec-other-val').value)||0
    };
    state.settings.ttfMultiplier = parseFloat(document.getElementById('ttf-multiplier').value)||3412;
    updateUI();
}

function updateMtmPrice(key, val) {
    const pos = state.positions.find(p => p.key === key);
    if(pos) { state.marketPrices[pos.contract] = parseFloat(val); updateUI(); }
}

function updateContractOptions() {
    const p = document.getElementById('product').value;
    document.getElementById('contract').innerHTML = (config.contracts[p] || []).map(c => `<option value="${c}">${c}</option>`).join('');
    document.getElementById('price').placeholder = (p === 'Henry Hub' || p === 'TTF') ? '2.8500' : '85.500';
}

function filterTable(inputId, tableId) { 
    const term = document.getElementById(inputId).value.toLowerCase(); 
    const rows = document.getElementById(tableId).getElementsByTagName('tr'); 
    for(let r of rows) { 
        if(r.classList.contains('subtotal-row') || r.innerText.includes('æ€»è®¡')) continue; 
        r.style.display = r.textContent.toLowerCase().includes(term) ? '' : 'none'; 
    } 
}

function calcReconcile() {
    const r=parseFloat(document.getElementById('rec-app-realized').textContent.replace('$',''))||0; 
    const f=parseFloat(document.getElementById('rec-app-floating').textContent.replace('$',''))||0;
    const a1=parseFloat(document.getElementById('modal-rec-base').value)||0; 
    const a2=parseFloat(document.getElementById('modal-rec-other').value)||0; 
    const s=parseFloat(document.getElementById('rec-statement-val').value)||0;
    const net=r+f-a1-a2; 
    document.getElementById('rec-app-net').textContent=`$${net.toFixed(2)}`;
    const diff=s-net; 
    document.getElementById('rec-diff-val').textContent=(diff>0?'+':'')+diff.toFixed(2);
    const bEl=document.getElementById('rec-result-box'); const tEl=document.getElementById('rec-status-text');
    if(Math.abs(diff)<1) { bEl.className='mt-6 p-4 rounded-lg text-center bg-green-100 text-green-800'; tEl.textContent='âœ… è´¦ç›®å»åˆ'; } 
    else { bEl.className='mt-6 p-4 rounded-lg text-center bg-red-100 text-red-800'; tEl.textContent='âŒ å­˜åœ¨å·®å¼‚'; }
}

// --- COMPLEX PARSING LOGIC v6.7 (Optimized Batch) ---
function parseImportText() {
    const text = document.getElementById('batch-input').value;
    const rawLines = text.split('\n').filter(l => l.trim());
    const merged = [];
    rawLines.forEach(l => {
        const isNumOnly = /^\s*(\d+(\.\d+)?(\s+|,|$))+/.test(l) && !/[a-z]/i.test(l);
        if(isNumOnly && merged.length) merged[merged.length-1] += " " + l;
        else merged.push(l);
    });
    
    parsedTradesBuffer = [];
    let validCount = 0;
    const monthMap = {'JAN':'01','FEB':'02','MAR':'03','APR':'04','MAY':'05','JUN':'06','JUL':'07','AUG':'08','SEP':'09','OCT':'10','NOV':'11','DEC':'12'};
    
    merged.forEach(line => {
        try {
            // Pre-cleaning
            let clean = line.replace(/^(to\s+)?confirm\s+(u\s+)?/i, '')
                            .replace(/^\s*\d+([.)\uff09\]]|\s+)/, '') 
                            .replace(/(\d+(\.\d+)?)\s*(SCN|SCREEN|PX)\b/ig, '') 
                            .toUpperCase();
            
            let trader = document.getElementById('trader').value;
            if(/\bD\b/.test(clean)) trader = 'D'; else if(/\bW\b/.test(clean)) trader = 'W'; else if(/\bL\b/.test(clean)) trader = 'L'; else if(/\bZ\b/.test(clean)) trader = 'Z';

            let product = 'Brent'; 
            if(/HH|HENRY/.test(clean)) product = 'Henry Hub'; else if(/JKM/.test(clean)) product = 'JKM'; else if(/TTF/.test(clean)) product = 'TTF';
            
            let side = 1; if(/SELL|SOLD|SHORT/.test(clean)) side = -1;
            
            let qty = 0;
            const qMatch = clean.match(/(\d+(\.\d+)?)(\s*X|\s*KB|\s*LOTS)/) || clean.match(/(\d+(\.\d+)?)\s*(\/M|PM)/);
            if(qMatch) { qty = parseFloat(qMatch[1]); clean = clean.replace(qMatch[0], ''); }
            
            let price = 0;
            const otcMatch = clean.match(/OTC(?:\s*PX)?\s*(\d+(\.\d+)?)/) || clean.match(/(\d+(\.\d+)?)\s*OTC/);
            if(otcMatch) price = parseFloat(otcMatch[1]);
            else { const atMatch = clean.match(/AT\s*(\d+(\.\d+)?)/); if(atMatch) price = parseFloat(atMatch[1]); }
            
            const rangeRgx = /\b(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)(\d{2})?\s*(-|TO)\s*(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)(\d{2})?\b/;
            const rangeMatch = clean.match(rangeRgx);
            
            if(rangeMatch && qty > 0) {
                const sM = monthMap[rangeMatch[1]]; const eM = monthMap[rangeMatch[4]];
                const sY = rangeMatch[2] || '26'; const eY = rangeMatch[5] || sY;
                let startIdx = parseInt(sM) + (parseInt(sY)-26)*12 - 1; let endIdx = parseInt(eM) + (parseInt(eY)-26)*12 - 1;
                const leftovers = clean.replace(rangeMatch[0], '').replace(/OTC|AT|PM/g, '');
                const prices = (leftovers.match(/-?\d+(\.\d+)?/g)||[]).map(Number).filter(n => n > 10 || n < 5); 
                const count = endIdx - startIdx + 1;
                let finalPrices = Array(count).fill(price);
                if(prices.length === count + 1 && prices.includes(price)) { prices.splice(prices.indexOf(price), 1); }
                if(prices.length === count) finalPrices = prices;
                
                for(let i=0; i<count; i++) {
                    const absM = (startIdx + i) % 12 + 1; const absY = 26 + Math.floor((startIdx + i)/12);
                    const cName = (product==='Henry Hub'?'HH':'') + absY + String(absM).padStart(2,'0');
                    parsedTradesBuffer.push({ isValid: true, trader, product, contract: cName, quantity: qty*side, price: finalPrices[i], side });
                }
                validCount++;
            } else if (qty > 0) {
                const mMatch = clean.match(/\b(\d{2})-(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\b/) || clean.match(/\b(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\s*(\d{2})?\b/);
                const qMatch = clean.match(/\b(26|27)Q[1-4]\b/); 
                let cName = '';
                if(qMatch) { cName = qMatch[0]; } else if(mMatch) {
                    let mStr = mMatch[1].length===2 ? mMatch[2] : mMatch[1]; let yStr = mMatch[1].length===2 ? mMatch[1] : (mMatch[2]||'26');
                    cName = (product==='Henry Hub'?'HH':'') + yStr + monthMap[mStr];
                }
                if(cName && price > 0) { parsedTradesBuffer.push({ isValid: true, trader, product, contract: cName, quantity: qty*side, price, side }); validCount++; }
            }
        } catch(e) { console.error(e); }
    });
    
    // Optimized Render for Preview
    const rowsHtml = parsedTradesBuffer.map(t => `<tr class="border-b"><td class="px-2">âœ…</td><td>${t.trader}</td><td>${t.product}</td><td>${t.contract}</td><td>${t.side>0?'ä¹°':'å–'}</td><td>${Math.abs(t.quantity)}</td><td>${t.price}</td></tr>`).join('');
    document.getElementById('import-preview-body').innerHTML = rowsHtml;
    document.getElementById('btn-batch-submit').disabled = validCount === 0; document.getElementById('import-preview-container').classList.remove('hidden');
}
function batchSubmitTrades() {
    parsedTradesBuffer.forEach(t => { state.transactionLog.push({ id: Date.now()+Math.random(), date: new Date().toISOString(), trader: t.trader, product: t.product, contract: t.contract, quantity: t.quantity, price: t.price, status: 'active', type: 'regular' }); });
    updateUI(); closeBatchImportModal(); openInfoModal('æˆåŠŸ', `å·²å¯¼å…¥ ${parsedTradesBuffer.length} æ¡äº¤æ˜“`);
}

// --- RENDER & EXPORT ---
function renderAll() {
    renderPositions(); renderLogs(); renderHistory(); 
    document.getElementById('pos-count-badge').textContent = state.positions.length;
}

function renderPositions() {
    const tbody = document.getElementById('positions-table'); 
    let html = '';
    let totalF = 0, grandNetQty = 0;
    const grouped = state.positions.reduce((acc, p) => { (acc[p.product] = acc[p.product] || []).push(p); return acc; }, {});
    
    Object.keys(grouped).sort().forEach(prod => {
        let subQty = 0, subCost = 0, subPL = 0;
        const rows = grouped[prod].sort((a,b) => a.contract.localeCompare(b.contract));
        
        rows.forEach(p => {
            const avg = p.quantity !== 0 ? p.totalValue / p.quantity : 0;
            const mtm = state.marketPrices[p.contract] || avg;
            const mult = p.product === 'TTF' ? state.settings.ttfMultiplier : config.contractMultipliers[p.product] || 1000;
            const gross = (mtm * p.quantity * mult) - (p.totalValue * mult);
            const feeRate = p.product==='Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
            const fee = Math.abs(p.quantity) * mult * feeRate;
            const net = gross - fee;
            totalF += net; subPL += net; subQty += p.quantity; subCost += p.totalValue * mult; grandNetQty += p.quantity;
        });
        
        let subWAvg = Math.abs(subQty) > 0.001 ? (subCost / (subQty * (prod === 'TTF' ? state.settings.ttfMultiplier : config.contractMultipliers[prod]))) : 0;
        const badgeClass = config.colors[prod] || 'badge-brent';
        const plColor = subPL >= 0 ? 'text-green-600' : 'text-red-600';

        html += `
            <tr class="subtotal-row border-b border-t border-gray-200">
                <td class="px-4 py-2"><span class="badge ${badgeClass}">${prod}</span></td>
                <td class="px-4 py-2 text-xs uppercase">SUBTOTAL</td>
                <td class="px-4 py-2 text-right font-mono font-bold">${subQty.toFixed(3)}</td>
                <td class="px-4 py-2"></td>
                <td class="px-4 py-2 text-right text-xs text-gray-500">W.Avg: ${subWAvg.toFixed(4)}</td>
                <td class="px-4 py-2"></td>
                <td class="px-4 py-2 text-right font-bold ${plColor}">${subPL.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                <td colspan="2"></td>
            </tr>`;

        rows.forEach((p) => {
            const avg = p.quantity !== 0 ? p.totalValue / p.quantity : 0;
            const mtm = state.marketPrices[p.contract] || avg;
            const mult = p.product === 'TTF' ? state.settings.ttfMultiplier : config.contractMultipliers[p.product] || 1000;
            const feeRate = p.product==='Brent' ? state.settings.fees.brentPerBbl : state.settings.fees.hhPerMMBtu;
            const net = ((mtm * p.quantity) - p.totalValue) * mult - (Math.abs(p.quantity) * mult * feeRate);
            const rmb = state.settings.exchangeRateRMB || 7.13;
            let landed = 0;
            if(p.product === 'Brent') landed = (avg * 0.134 + 0.46) * rmb / 28.3;
            else if(p.product === 'Henry Hub') landed = (avg * 1.15 + 4.5) * rmb / 28.3;
            const uniqueId = `${p.key}`; 
            
            // Add Unit
            const unit = p.product === 'Brent' ? 'bbl' : (p.product === 'TTF' ? 'MWh' : 'MMBtu');
            const dirBadge = p.quantity > 0 ? '<span class="badge badge-long">Long</span>' : '<span class="badge badge-short">Short</span>';
            const plClass = net >= 0 ? 'text-green-600' : 'text-red-600';
            
            html += `
                <tr class="border-b table-row-hover transition-colors bg-white">
                    <td class="px-4 py-3 font-medium pl-8 border-l-4 border-transparent hover:border-indigo-200">${p.trader}</td>
                    <td class="px-4 py-3 font-mono">${p.contract} <span class="text-xs text-gray-300 ml-1">${unit}</span></td>
                    <td class="px-4 py-3 text-right font-mono">${Math.abs(p.quantity).toFixed(3)}</td>
                    <td class="px-4 py-3 text-center">${dirBadge}</td>
                    <td class="px-4 py-3 text-right text-gray-500">${avg.toFixed(3)}</td>
                    <td class="px-4 py-3 text-right"><input type="number" step="0.01" value="${mtm.toFixed(3)}" class="w-20 text-right text-xs border rounded px-1" onchange="updateMtmPrice('${uniqueId}', this.value)"></td>
                    <td class="px-4 py-3 text-right font-bold ${plClass}">${net.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="px-4 py-3 text-right text-xs text-gray-400">${landed ? landed.toFixed(4) : '-'}</td>
                    <td class="px-4 py-3 text-center"><button onclick="reverseTradeByPos('${uniqueId}')" class="text-xs text-red-500 hover:underline">æ’¤é”€</button></td>
                </tr>`;
        });
    });
    
    tbody.innerHTML = html;
    document.getElementById('total-floating-pl').textContent = totalF.toLocaleString('en-US', {style:'currency', currency:'USD'});
    document.getElementById('total-floating-pl').className = `px-4 py-3 text-right font-bold text-lg ${totalF>=0?'text-green-600':'text-red-600'}`;
    document.getElementById('total-net-qty').textContent = grandNetQty.toFixed(3);
}

function renderLogs() {
    const tbody = document.getElementById('log-table'); 
    // Limit to last 500 for performance
    const logs = state.transactionLog.filter(l => l.status === 'active').sort((a,b) => b.date.localeCompare(a.date)).slice(0, 500);
    const html = logs.map(l => `<tr class="border-b hover:bg-gray-50"><td class="px-2 py-2">${l.date.substring(5,16).replace('T',' ')}</td><td class="font-bold text-xs">${l.trader}</td><td>${l.contract}</td><td class="${l.quantity>0?'text-green-600':'text-red-600'}">${l.quantity}</td><td>${l.price}</td><td><button onclick="reverseTrade(${l.id})" class="text-gray-400 hover:text-red-500">Ã—</button></td></tr>`).join('');
    tbody.innerHTML = html;
}
function renderHistory() {
    const tbody = document.getElementById('history-table'); 
    let total = state.settings.initialRealizedPL || 0;
    const history = [...state.history].sort((a,b) => new Date(b.date) - new Date(a.date));
    const recent = history.slice(0, 500);
    
    // Calc total from full history, render only recent
    history.forEach(h => total += h.realizedPL);
    
    const html = recent.map(h => `<tr class="border-b hover:bg-gray-50"><td class="px-2 py-2">${h.date.split('T')[0].substring(5)}</td><td>${h.contract}</td><td>${h.closedQuantity.toFixed(1)}</td><td class="font-bold ${h.realizedPL>=0?'text-green-600':'text-red-600'}">${h.realizedPL.toFixed(0)}</td></tr>`).join('');
    tbody.innerHTML = html;
    document.getElementById('total-realized-pl').textContent = total.toLocaleString('en-US', {style:'currency', currency:'USD'});
}

function exportData() {
    const dataStr = JSON.stringify(state, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `trade_data_export_${new Date().toISOString()}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href);
}
function importData(event) {
    const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
    reader.onload = e => { try { const imported = JSON.parse(e.target.result); if (imported.transactionLog) { state = imported; hydrateState(); updateUI(); openInfoModal('æˆåŠŸ', 'æ•°æ®å¯¼å…¥æˆåŠŸ!'); } } catch (err) { openInfoModal('é”™è¯¯', 'æ–‡ä»¶é”™è¯¯'); } }; reader.readAsText(file); event.target.value = '';
}
function importMtmData(event) {
    const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
    reader.onload = function(e) { try { const importedData = JSON.parse(e.target.result); if (!importedData.marketPrices) throw new Error("ç¼ºå°‘ marketPrices"); const newPrices = importedData.marketPrices; for (const [contract, price] of Object.entries(newPrices)) { state.marketPrices[contract] = parseFloat(price); } updateUI(); openInfoModal('æˆåŠŸ', 'è¡Œæƒ…æ›´æ–°æˆåŠŸ'); } catch (error) { openInfoModal('å¤±è´¥', error.message); } }; reader.readAsText(file); event.target.value = '';
}
function exportLedgerCSV() {
    const headers = ["æ—¥æœŸ", "å“ç§", "åˆçº¦", "å½“æ—¥å¼€ä»“", "å¼€ä»“å‡ä»·", "å½“æ—¥å¹³ä»“", "å¹³ä»“å‡ä»·", "æœŸæœ«æŒä»“", "æŒä»“å‡ä»·", "ç»“ç®—ä»·(MTM)", "å½“æ—¥å®ç°ç›ˆäº(USD)", "å½“æ—¥å®ç°ç›ˆäº(å…ƒ)", "æœªå¹³ä»“ç›ˆäº(USD)", "æœªå¹³ä»“ç›ˆäº(å…ƒ)"];
    const dataRows = []; const activeLogs = state.transactionLog.filter(log => log.status === 'active'); activeLogs.sort((a, b) => new Date(a.date) - new Date(b.date));
    const logsByDay = {}; activeLogs.forEach(log => { const day = formatDateForExport(log.date, false); if (!logsByDay[day]) logsByDay[day] = []; logsByDay[day].push(log); });
    const rmbRate = state.settings.exchangeRateRMB || 7.13;
    Object.keys(logsByDay).sort().forEach(day => {
        dataRows.push({ "æ—¥æœŸ": day, "å“ç§": "SUMMARY", "åˆçº¦": "Generated" });
    });
    exportToCSV(headers, dataRows, "daily_ledger.csv");
}
function exportPositionsCSV() {
    const headers = ["åˆçº¦", "æ•°é‡", "å‡ä»·", "MTM", "æµ®åŠ¨P/L"]; 
    const data = state.positions.map(p => ({ "åˆçº¦": p.contract, "æ•°é‡": p.quantity, "å‡ä»·": (p.totalValue/p.quantity).toFixed(2) }));
    exportToCSV(headers, data, "positions.csv");
}
function exportLogCSV() {
    const headers = ["æ—¶é—´", "åˆçº¦", "æ•°é‡", "ä»·æ ¼"]; 
    const data = state.transactionLog.filter(l=>l.status==='active').map(l => ({ "æ—¶é—´": l.date, "åˆçº¦": l.contract, "æ•°é‡": l.quantity, "ä»·æ ¼": l.price }));
    exportToCSV(headers, data, "logs.csv");
}
function exportHistoryCSV() {
    const headers = ["æ—¥æœŸ", "åˆçº¦", "ç›ˆäº"]; 
    const data = state.history.map(h => ({ "æ—¥æœŸ": h.date, "åˆçº¦": h.contract, "ç›ˆäº": h.realizedPL }));
    exportToCSV(headers, data, "history.csv");
}
function exportToCSV(headers, data, filename) {
    const csv = [headers.join(',')].concat(data.map(row => headers.map(h => row[h]).join(','))).join('\n');
    const blob = new Blob(['\uFEFF'+csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link);
}
function generateDailyReport() {
    const today = new Date().toISOString().split('T')[0];
    const logs = state.transactionLog.filter(l => l.status==='active' && l.date.startsWith(today));
    const histPL = state.history.filter(h => h.date.startsWith(today)).reduce((a,b)=>a+b.realizedPL,0);
    let floating = 0; state.positions.forEach(p => { const curr = state.marketPrices[p.contract] || (p.totalValue/p.quantity); floating += ((curr*p.quantity*config.contractMultipliers[p.product]) - (p.totalValue*config.contractMultipliers[p.product])); });
    document.getElementById('daily-report-content').textContent = `ğŸ“… ${today}\nå®ç°ç›ˆäº: $${histPL.toFixed(0)}\næµ®åŠ¨ç›ˆäº: $${floating.toFixed(0)}\näº¤æ˜“ç¬”æ•°: ${logs.length}`;
    document.getElementById('report-modal').classList.remove('hidden');
}
function exportNotebookLMData() {
    let txt = `è´¦æˆ·æ¦‚è§ˆ\nç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}\n`;
    state.positions.forEach(p => txt += `${p.product} ${p.contract}: ${p.quantity} @ ${(p.totalValue/p.quantity).toFixed(2)}\n`);
    const blob = new Blob([txt], {type:'text/plain'}); const link = document.createElement('a'); link.href=URL.createObjectURL(blob); link.download='ai_context.txt'; link.click();
}
function runStressTest() { alert("å‹åŠ›æµ‹è¯•è®¡ç®—ä¸­..."); }

// ==================== 9. EXECUTION ====================
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    hydrateState();
    initializeUI();
    rebuildStateFromLogs();
    renderAll();
    document.getElementById('trade-form').addEventListener('submit', handleTradeSubmit);
    document.getElementById('edit-form').addEventListener('submit', handleEditSubmit);
});
</script>
</body>
</html>
